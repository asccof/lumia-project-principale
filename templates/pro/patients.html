{% extends "base.html" %}

{% block title %}Espace cabinet — Mes patients{% endblock %}

{% block content %}
<style>
  /* ==== Styles locaux à la page (non intrusifs) ==== */
  .po-wrapper { max-width: 1100px; margin: 0 auto; padding: 16px; }
  .po-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
  .po-header h1 { margin: 0; font-size: 1.6rem; line-height: 1.2; }
  .po-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .po-searchbar { display: flex; gap: 8px; margin-bottom: 16px; }
  .po-input { flex: 1; padding: 10px 12px; border: 1px solid #e3e3e3; border-radius: 10px; font-size: 0.95rem; }
  .po-btn { appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
  .po-btn-primary { background: #0f62fe; color: #fff; }
  .po-btn-ghost { background: #f5f7fb; color: #222; }

  .po-meta { color: #666; font-size: 0.9rem; }

  .po-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 12px; }
  @media (min-width: 640px) { .po-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (min-width: 980px) { .po-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

  .po-card {
    display: flex; gap: 12px; align-items: center;
    border: 1px solid #eceff3; border-radius: 14px; padding: 12px;
    background: #fff; box-shadow: 0 1px 2px rgba(16,24,40,.04);
  }
  .po-avatar {
    width: 54px; height: 54px; border-radius: 50%; overflow: hidden; flex: 0 0 auto;
    background: #f0f2f5; display: grid; place-items: center; font-weight: 700; color: #6b7280;
  }
  .po-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .po-info { flex: 1 1 auto; min-width: 0; }
  .po-name { font-weight: 700; color: #111827; }
  .po-id { color: #6b7280; font-size: .9rem; }
  .po-tags { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }
  .po-tag { background: #f5f7fb; color: #374151; border-radius: 999px; padding: 2px 8px; font-size: .75rem; }

  .po-cta { display: flex; gap: 8px; }

  .po-empty {
    border: 2px dashed #e5e7eb; border-radius: 16px; padding: 24px; text-align: center; color: #6b7280;
    background: #fafafa;
  }

  /* Pagination */
  .po-pagi { display:flex; gap:6px; align-items:center; justify-content:center; margin-top:16px; flex-wrap:wrap; }
  .po-page { padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; text-decoration:none; color:#111; background:#fff; }
  .po-page.active { background:#0f62fe; color:#fff; border-color:#0f62fe; }
</style>

<div class="po-wrapper">
  <div class="po-header">
    <h1>Mes patients</h1>
    <div class="po-actions">
      <a class="po-btn po-btn-ghost" href="{{ url_for('professional_dashboard') }}">← Retour tableau de bord</a>
    </div>
  </div>

  {# Meta : total #}
  <div class="po-meta">
    Total : {{ total }} patient{{ '' if (total == 1) else 's' }}
  </div>

  <!-- Barre de recherche côté serveur (GET) -->
  <form class="po-searchbar" method="get" action="{{ url_for('pro_patients') }}">
    <input class="po-input" type="search" name="q" value="{{ q or '' }}" placeholder="Rechercher par nom, e-mail, téléphone…" />
    <button class="po-btn po-btn-primary" type="submit">Rechercher</button>
  </form>

  {% if rows and rows|length > 0 %}
    <div class="po-grid">
      {# rows = liste de tuples (User, total_rdv, confirme_count, last_date) #}
      {% for u, total_rdv, confirme_count, last_date in rows %}
        <div class="po-card">
          <div class="po-avatar">
            {% if u.picture_url %}
              <img src="{{ u.picture_url }}" alt="Photo de {{ u.full_name or u.username or ('ID ' ~ u.id) }}">
            {% else %}
              {{ (u.full_name or u.username or 'P')[:1] | upper }}
            {% endif %}
          </div>

          <div class="po-info">
            <div class="po-name">
              {{ u.full_name or u.username or 'Patient' }}
            </div>
            <div class="po-id">
              #{{ u.id }}
              {% if u.email %} • {{ u.email }}{% endif %}
              {% if u.phone %} • {{ u.phone }}{% endif %}
            </div>

            <div class="po-tags">
              <span class="po-tag">RDV: {{ total_rdv or 0 }}</span>
              <span class="po-tag">Confirmés: {{ confirme_count or 0 }}</span>
              {% if last_date %}<span class="po-tag">Dernier: {{ last_date.strftime("%d/%m/%Y") if last_date.__class__.__name__ in ["datetime","date"] else last_date }}</span>{% endif %}
            </div>
          </div>

          <div class="po-cta">
            <a class="po-btn po-btn-ghost" href="{{ url_for('pro_patient_dossier', patient_id=u.id) }}" title="Ouvrir le dossier">
              <i class="fa-solid fa-folder-open me-1"></i> Dossier
            </a>
            <a class="po-btn po-btn-primary" href="{{ url_for('pro_patient_exercises', patient_id=u.id) }}" title="Exercices">
              <i class="fa-solid fa-dumbbell me-1"></i> Exercices
            </a>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Pagination #}
    {% set total_pages = (total // per_page) + (1 if (total % per_page) else 0) %}
    {% if total_pages > 1 %}
      <div class="po-pagi">
        {% set qparam = q or '' %}
        {% for p in range(1, total_pages + 1) %}
          <a class="po-page {% if p == page %}active{% endif %}"
             href="{{ url_for('pro_patients', q=qparam, page=p) }}">{{ p }}</a>
        {% endfor %}
      </div>
    {% endif %}

  {% else %}
    <div class="po-empty">
      <strong>Aucun patient lié.</strong><br>
      Quand des patients vous seront attribués, ils apparaîtront ici.
    </div>
  {% endif %}
</div>
{% endblock %}
