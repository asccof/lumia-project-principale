{% extends "base.html" %}
{% block title %}Tighri{% endblock %}

{% block extra_css %}
<style>
  :root{--primary:#8B5CF6;--primary-dark:#6D28D9;--ink:#2d1a47;--muted:#4B3869;--bg:#f7f5fa;--card:#fff;--shadow:0 2px 12px rgba(139,92,246,.1);--radius:18px}
  body{background:var(--bg);color:var(--ink)}
  header{background:linear-gradient(90deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;padding:8rem 0 2rem;text-align:center}
  header h1{margin:0 0 .5rem;font-size:3rem;font-weight:700}
  header p{margin:0 auto 1.5rem;max-width:700px;font-size:1.15rem;opacity:.95}
  .search-wrap{max-width:1100px;margin:-2.5rem auto 1rem;padding:0 1rem}

  /* Desktop: barre intacte (colonne en plus pour Famille) */
  .search-bar{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto;gap:.5rem;background:#fff;padding:.5rem;border-radius:999px;box-shadow:var(--shadow)}
  .search-bar select,.search-bar input{border:1.5px solid #e6dcff;border-radius:999px;padding:.7rem .9rem}
  .search-bar button{padding:.75rem 1.25rem;border:none;background:var(--primary);color:#fff;border-radius:999px;font-weight:700}
  .search-bar button:hover{background:var(--primary-dark)}
  @media (max-width:960px){ .search-bar{grid-template-columns:1fr 1fr} }

  /* Mobile: on ne montre que les actions, le reste passe dans le panneau */
  @media (max-width:640px){
    .search-bar{grid-template-columns:1fr;gap:.5rem}
    .desktop-only{display:none !important}
  }
  .search-actions{display:flex;align-items:center;gap:.5rem}
  .btn-icon{display:inline-flex;align-items:center;gap:.4rem}
  .btn-icon svg{width:16px;height:16px}

  /* Panneau avanc√© MOBILE-ONLY (q + ville + famille + sp√©cialit√© + mode) */
  @media (max-width:640px){
    #mobile-advanced-filters{
      overflow:hidden;max-height:0;opacity:0;transform:translateY(-4px);
      transition:max-height .28s ease,opacity .25s ease,transform .25s ease;
      background:#fff;border-radius:16px;padding:0 .5rem;box-shadow:var(--shadow)
    }
    #mobile-advanced-filters.is-open{max-height:600px;opacity:1;transform:translateY(0);padding:.5rem}
    #mobile-advanced-filters .adv-stack{display:grid;grid-template-columns:1fr;gap:.5rem}
    .adv-head{display:flex;justify-content:flex-end}
    .adv-close{border:none;background:transparent;font-size:1.25rem;line-height:1;padding:.25rem .5rem;cursor:pointer;color:#6D28D9}
  }
  @media (min-width:641px){
    #mobile-advanced-filters{display:contents}
    .mobile-only{display:none !important}
  }

  /* Sections */
  .sections{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin:3rem 0;padding:0 2rem}
  .section{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:2.5rem;min-width:320px;max-width:400px;flex:1 1 320px;text-align:center}
  .section h2{color:var(--primary);margin:0 0 1rem}
  .section p{color:var(--muted);margin:0 0 1.5rem}
  .section a{display:inline-block;background:var(--primary);color:#fff;padding:1rem 2rem;border-radius:30px;text-decoration:none;font-weight:700}
  .section a:hover{background:var(--primary-dark)}

  /* Grilles pros */
  .featured{max-width:1200px;margin:0 auto 3rem;padding:0 2rem}
  .featured h3{color:#6D28D9;margin:0 0 1.5rem;text-align:center;font-size:2rem}
  .professionals{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:1.25rem;justify-items:center}
  @media (max-width:1024px){ .professionals{grid-template-columns:repeat(2,minmax(260px,1fr))} }
  @media (max-width:640px){ .professionals{grid-template-columns:1fr} }
  .professional-card{background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(139,92,246,.08);padding:1.25rem;min-width:260px;max-width:340px;width:100%;text-align:center}
  .professional-card .avatar-box{width:96px;height:96px;border-radius:50%;overflow:hidden;background:#eee;margin:0 auto .85rem}
  .professional-card .avatar-img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;cursor:zoom-in}
  .professional-card h4{margin:.5rem 0 .2rem;color:#6D28D9}
  .professional-card p{color:#4B3869;font-size:.95rem;margin:.35rem 0}
  .professional-card a{color:var(--primary);text-decoration:none;font-weight:600}
  .professional-card a:hover{text-decoration:underline}

  /* Bandeau autre pros */
  .strip{max-width:1200px;margin:0 auto 4rem;padding:0 2rem}
  .strip h3{color:#6D28D9;margin:0 0 1rem;font-size:1.5rem}
  .hscroll{display:flex;gap:1rem;overflow-x:auto;padding-bottom:.5rem;scroll-snap-type:x mandatory}
  .hscroll::-webkit-scrollbar{height:8px}.hscroll::-webkit-scrollbar-thumb{background:#d8cfff;border-radius:999px}
  .card-mini{scroll-snap-align:start;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(139,92,246,.08);padding:1rem;min-width:240px;max-width:240px;text-align:center;flex:0 0 auto}
  .card-mini .avatar-box{width:84px;height:84px;border-radius:50%;overflow:hidden;background:#eee;margin:0 auto .6rem}
  .card-mini .avatar-img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .card-mini h4{margin:.4rem 0 .1rem;color:#6D28D9;font-size:1rem}
  .card-mini p{margin:0;color:#4B3869;font-size:.9rem}

  /* Badges (home) */
  .tg-badges{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;margin:.25rem 0}
  .tg-badge{display:inline-block;font-size:.75rem;font-weight:700;padding:.2rem .55rem;border-radius:999px}
  .tg-badge.tighri{background:#8B5CF6;color:#fff}
  .tg-badge.anthecc{background:#22c55e;color:#fff}
  .tg-badge.sm{font-size:.68rem;padding:.15rem .45rem}

  /* Thumbnails secondaires (nouveau) */
  .thumbs{display:flex;gap:.35rem;justify-content:center;align-items:center;margin-top:.45rem}
  .thumb{width:40px;height:40px;border-radius:8px;overflow:hidden;background:#eee;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .thumb-img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .thumbs-mini{display:flex;gap:.3rem;justify-content:center;margin-top:.35rem}
  .thumb-mini{width:32px;height:32px;border-radius:7px;overflow:hidden;background:#eee;box-shadow:0 1px 4px rgba(0,0,0,.05)}
  .thumb-mini .thumb-img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}

  /* Lightbox */
  .lightbox-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
  .lightbox-backdrop.is-open{display:flex}
  .lightbox-img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .lightbox-close{position:absolute;top:10px;right:10px;border:none;background:#fff;border-radius:999px;padding:.4rem .6rem;cursor:pointer}
</style>
{% endblock %}

{% block content %}
  <header id="top">
    <h1>{{ t('home.title','Tighri') }}</h1>
    <p>{{ t('home.tagline','La plateforme marocaine pour prendre rendez-vous avec des psychologues, th√©rapeutes et coachs certifi√©s') }}</p>
  </header>

  <div class="search-wrap">
    {# Formulaire (desktop = inline ; mobile = panneau) #}
    <form id="tighri-search-form" class="search-bar" method="get" action="{{ url_for('professionals') }}">
      {# ==== q (desktop) ==== #}
      <input class="desktop-only" type="text" name="q" id="q-desktop"
             placeholder="{{ t('search.q','Nom, mot-cl√©...') }}" aria-label="{{ t('search.q','Nom, mot-cl√©...') }}"
             value="{{ request.args.get('q','') }}">

      {# ==== Panneau (contents en desktop) : q + Ville + Famille + Sp√©cialit√© + Mode ==== #}
      <div id="mobile-advanced-filters" aria-hidden="true">
        <div class="adv-head"><button type="button" class="adv-close" id="advClose" aria-label="Fermer">‚úï</button></div>
        <div class="adv-stack">
          <!-- q (mobile) -->
          <input class="mobile-only" type="text" name="q" id="q-mobile"
                 placeholder="{{ t('search.q','Nom, mot-cl√©...') }}" aria-label="{{ t('search.q','Nom, mot-cl√©...') }}"
                 value="{{ request.args.get('q','') }}">

          <!-- Ville -->
          {% if cities is defined and cities %}
            <select name="city_id" aria-label="{{ t('search.city','Ville') }}">
              <option value="">{{ t('search.city','Ville') }}</option>
              {% for c in cities %}
                <option value="{{ c.id }}" {% if request.args.get('city_id')==c.id|string %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input type="text" name="city" placeholder="{{ t('search.city','Ville') }}" aria-label="{{ t('search.city','Ville') }}" value="{{ request.args.get('city','') }}">
          {% endif %}

          <!-- Famille (cat√©gorie) -->
          {% if families is defined and families %}
            <select name="family" aria-label="{{ t('search.family','Famille') }}">
              <option value="">{{ t('search.family','Famille') }}</option>
              {% for f in families %}
                <option value="{{ f.name }}" {% if request.args.get('family','')==f.name %}selected{% endif %}>{{ f.name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input type="text" name="family" placeholder="{{ t('search.family','Famille') }}" aria-label="{{ t('search.family','Famille') }}" value="{{ request.args.get('family','') }}">
          {% endif %}

          <!-- Sp√©cialit√© -->
          {% if specialties is defined and specialties %}
            <select name="specialty_id" aria-label="{{ t('search.specialty','Sp√©cialit√©') }}">
              <option value="">{{ t('search.specialty','Sp√©cialit√©') }}</option>
              {% for s in specialties %}
                <option value="{{ s.id }}" {% if request.args.get('specialty_id')==s.id|string %}selected{% endif %}>{{ s.name }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input type="text" name="specialty" placeholder="{{ t('search.specialty','Sp√©cialit√©') }}" aria-label="{{ t('search.specialty','Sp√©cialit√©') }}" value="{{ request.args.get('specialty','') }}">
          {% endif %}

          <!-- Mode -->
          <select name="mode" aria-label="{{ t('search.mode','Mode') }}">
            <option value="">{{ t('search.mode','Mode') }}</option>
            <option value="cabinet"  {% if request.args.get('mode')=='cabinet' %}selected{% endif %}>{{ t('mode.cabinet','Cabinet') }}</option>
            <option value="visio"    {% if request.args.get('mode')=='visio' %}selected{% endif %}>{{ t('mode.visio','Visio') }}</option>
            <option value="domicile" {% if request.args.get('mode')=='domicile' %}selected{% endif %}>{{ t('mode.domicile','Domicile') }}</option>
          </select>
        </div>
      </div>

      {# ==== Actions ==== #}
      <div class="search-actions">
        <button id="btn-search-submit" type="submit" class="btn-icon" aria-expanded="false">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.867-3.833zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
          </svg>
          <span>{{ t('search.cta','Rechercher') }}</span>
        </button>

        <div class="form-check form-switch" style="margin:0 .25rem;">
          <input class="form-check-input" type="checkbox" id="switch-advanced"
                 aria-controls="mobile-advanced-filters" aria-label="Afficher les filtres"
                 {% if request.args.get('q') or request.args.get('city') or request.args.get('city_id') or request.args.get('family') or request.args.get('specialty') or request.args.get('specialty_id') or request.args.get('mode') %}checked{% endif %}>
          <label class="form-check-label" for="switch-advanced" style="font-size:.85rem;">Plus</label>
        </div>
      </div>
    </form>
  </div>

  {# ======= autres sections ======= #}
  <div class="sections">
    <div class="section">
      <h2>{{ t('cards.patient','Espace Patient') }}</h2>
      <p>{{ t('cards.patient_text','Consultez les profils, prenez rendez-vous en cabinet, √† domicile ou en vid√©o avec des professionnels certifi√©s.') }}</p>
      <a href="{{ url_for('register') }}">{{ t('cards.patient_btn','Espace Patient') }}</a>
    </div>
    <div class="section">
      <h2>{{ t('cards.pro','Espace Professionnel') }}</h2>
      <p>{{ t('cards.pro_text','Rejoignez Tighri pour proposer vos services et g√©rer vos rendez-vous en toute simplicit√©.') }}</p>
      <a href="{{ url_for('professional_register') }}">{{ t('cards.pro_btn','Espace Professionnel') }}</a>
    </div>
  </div>

  <div class="featured">
    <h3>{{ t('featured.title','Professionnels en vedette') }}</h3>
    {% set grid = top_professionals if top_professionals is defined else professionals %}
    <div class="professionals">
      {% for professional in grid %}
        {% set main = professional_photo_url(professional, 1) %}
        {% set sec1 = professional_photo_url(professional, 2) %}
        {% set sec2 = professional_photo_url(professional, 3) %}
        <div class="professional-card">
          <div class="avatar-box">
            <img class="avatar-img js-zoom"
                 src="{{ main }}"
                 data-full="{{ main }}"
                 alt="{{ t('alt.profile_photo','Photo de') }} {{ professional.name|e }}"
                 width="96" height="96" loading="lazy"
                 onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Photo';">
          </div>

          {# Miniatures secondaires (m√™me zoom) #}
          {% if sec1 or sec2 %}
          <div class="thumbs" aria-label="Galerie">
            {% if sec1 %}
              <div class="thumb">
                <img class="thumb-img js-zoom" src="{{ sec1 }}" data-full="{{ sec1 }}" alt="{{ professional.name|e }} ‚Äî photo 2" loading="lazy">
              </div>
            {% endif %}
            {% if sec2 %}
              <div class="thumb">
                <img class="thumb-img js-zoom" src="{{ sec2 }}" data-full="{{ sec2 }}" alt="{{ professional.name|e }} ‚Äî photo 3" loading="lazy">
              </div>
            {% endif %}
          </div>
          {% endif %}

          <h4>{{ professional.name }}</h4>

          <p>{% if professional.specialty %}{{ professional.specialty }}{% elif professional.primary_specialty %}{{ professional.primary_specialty.name }}{% else %}{{ t('labels.professional','Professionnel') }}{% endif %}</p>

          {# --- BADGES vedette --- #}
          {% if professional.certified_tighri or professional.approved_anthecc %}
            <div class="tg-badges" aria-label="Badges">
              {% if professional.certified_tighri %}
                <span class="tg-badge tighri">Certifi√© Tighri</span>
              {% endif %}
              {% if professional.approved_anthecc %}
                <span class="tg-badge anthecc">ANTHECC</span>
              {% endif %}
            </div>
          {% endif %}

          <p>
            {% set d = professional.description or '' %}
            {{ d[:80] }}{% if d|length > 80 %}‚Ä¶{% endif %}
          </p>
          <a href="{{ url_for('professional_detail', professional_id=professional.id) }}">{{ t('btn.view_profile','Voir le profil') }}</a>
        </div>
      {% endfor %}
    </div>
  </div>

  {% set other = (other_professionals if (other_professionals is defined and other_professionals) else (more_professionals if (more_professionals is defined and more_professionals) else [])) %}
  {% if other %}
  <section class="strip">
    <h3>{{ t('other.title','Autres professionnels') }}</h3>
    <div class="hscroll">
      {% for professional in other %}
      {% set main = professional_photo_url(professional, 1) %}
      {% set sec1 = professional_photo_url(professional, 2) %}
      {% set sec2 = professional_photo_url(professional, 3) %}
      <div class="card-mini">
        <div class="avatar-box">
          <img class="avatar-img js-zoom"
               src="{{ main }}"
               data-full="{{ main }}"
               alt="{{ t('alt.profile_photo','Photo de') }} {{ professional.name|e }}"
               width="84" height="84" loading="lazy"
               onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=Photo';">
        </div>

        {# miniatures secondaires sur mini-cartes #}
        {% if sec1 or sec2 %}
        <div class="thumbs-mini" aria-label="Galerie">
          {% if sec1 %}
            <div class="thumb-mini"><img class="thumb-img js-zoom" src="{{ sec1 }}" data-full="{{ sec1 }}" alt="{{ professional.name|e }} ‚Äî photo 2" loading="lazy"></div>
          {% endif %}
          {% if sec2 %}
            <div class="thumb-mini"><img class="thumb-img js-zoom" src="{{ sec2 }}" data-full="{{ sec2 }}" alt="{{ professional.name|e }} ‚Äî photo 3" loading="lazy"></div>
          {% endif %}
        </div>
        {% endif %}

        <h4>{{ professional.name }}</h4>

        {# --- BADGES mini --- #}
        {% if professional.certified_tighri or professional.approved_anthecc %}
          <div class="tg-badges" aria-label="Badges">
            {% if professional.certified_tighri %}
              <span class="tg-badge tighri sm">Tighri</span>
            {% endif %}
            {% if professional.approved_anthecc %}
              <span class="tg-badge anthecc sm">ANTHECC</span>
            {% endif %}
          </div>
        {% endif %}

        <p>{% if professional.specialty %}{{ professional.specialty }}{% elif professional.primary_specialty %}{{ professional.primary_specialty.name }}{% else %}‚Äî{% endif %}</p>
        <a href="{{ url_for('professional_detail', professional_id=professional.id) }}" style="color:var(--primary);font-weight:600;text-decoration:none">{{ t('btn.view','Voir') }}</a>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section id="about" class="about-section">
    <div class="about-container">
      <h2>{{ t('about.title','√Ä propos de Tighri') }}</h2>
      <p>{{ t('about.p1','Tighri est la premi√®re plateforme marocaine d√©di√©e √† la sant√© mentale et au bien-√™tre. Nous connectons patients et professionnels pour faciliter l\'acc√®s √† des soins psychologiques de qualit√©.') }}</p>
      <p>{{ t('about.p2','Notre mission est de d√©mocratiser l\'acc√®s aux services de sant√© mentale au Maroc, dans un environnement de confiance et de s√©curit√©.') }}</p>
    </div>
  </section>

  <section id="services" class="services-section">
    <div class="services-container">
      <h2>{{ t('services.title','Nos Services') }}</h2>
      <div class="services-grid">
        <div class="service-card"><h3>{{ t('services.cabinet','Consultations en Cabinet') }}</h3><p>{{ t('services.cabinet_p','Rencontrez des professionnels en face √† face.') }}</p></div>
        <div class="service-card"><h3>{{ t('services.home','Consultations √† Domicile') }}</h3><p>{{ t('services.home_p','Certains professionnels se d√©placent chez vous.') }}</p></div>
        <div class="service-card"><h3>{{ t('services.video','Consultations en Vid√©o') }}</h3><p>{{ t('services.video_p','Consultez en ligne en toute s√©curit√©.') }}</p></div>
        <div class="service-card"><h3>{{ t('services.planning','Gestion de Planning') }}</h3><p>{{ t('services.planning_p','R√©servez vos cr√©neaux, rappel 24h avant.') }}</p></div>
        <div class="service-card"><h3>{{ t('services.verified','Profils V√©rifi√©s') }}</h3><p>{{ t('services.verified_p','Dipl√¥mes et identit√©s v√©rifi√©s par Tighri.') }}</p></div>
        <div class="service-card"><h3>{{ t('services.support','Support 24/7') }}</h3><p>{{ t('services.support_p','Nous vous accompagnons √† chaque √©tape.') }}</p></div>
      </div>
    </div>
  </section>

  <section id="contact" class="contact-section">
    <div class="contact-container">
      <h2>{{ t('contact.title','Nous contacter') }}</h2>
      <p><strong>{{ t('contact.lead_strong','Bienvenue au Centre d\'√©coute et de conseil Tighri.') }}</strong><br>{{ t('contact.lead','Besoin d\'aide ou de conseils gratuits ? Contactez-nous.') }}</p>
      <div class="contact-info" style="margin-top:1rem;">
        <div class="contact-item"><strong>{{ t('contact.email','Email') }}</strong><span>contact@tighri.ma</span></div>
        <div class="contact-item"><strong>{{ t('contact.phone','T√©l√©phone') }}</strong><span>06 63 40 01 90</span></div>
        <div class="contact-item"><strong>{{ t('contact.whatsapp','WhatsApp') }}</strong><span class="contact-badge">{{ t('contact.available','Disponible') }}</span></div>
      </div>
      <div class="contact-actions">
        <a class="contact-btn" href="mailto:contact@tighri.ma?subject=Contact%20Tighri&body=Bonjour%20Tighri%2C">{{ t('contact.email_cta','‚úâÔ∏è Contacter par e-mail') }}</a>
        <a class="contact-btn" href="tel:+212663400190">üìû {{ t('contact.call_cta','Appeler le') }} <span>06 63 40 01 90</span></a>
        <a class="contact-btn" target="_blank" rel="noopener" href="https://wa.me/212663400190?text=Bonjour%20Tighri%2C%20j%E2%80%99ai%20besoin%20d%E2%80%99aide%20et%20de%20conseils.">üí¨ {{ t('contact.whatsapp_cta','WhatsApp direct') }}</a>
      </div>
    </div>
  </section>

  <div class="lightbox-backdrop" id="lbBackdrop" aria-modal="true" role="dialog">
    <button class="lightbox-close" id="lbClose" aria-label="{{ t('lightbox.close','Fermer') }}">‚úï</button>
    <img id="lbImg" class="lightbox-img" alt="{{ t('lightbox.zoom_alt','Agrandissement') }}">
  </div>

  <script>
    /* ===== Lightbox ===== */
    (function(){
      const b=document.getElementById('lbBackdrop'), img=document.getElementById('lbImg'), x=document.getElementById('lbClose');
      function open(src){ img.src=src; b.classList.add('is-open'); }
      function close(){ b.classList.remove('is-open'); img.src=''; }
      document.addEventListener('click',(e)=>{ const t=e.target.closest('.js-zoom'); if(!t) return;
        e.preventDefault(); open(t.getAttribute('data-full')||t.src||'');});
      x.addEventListener('click',close); b.addEventListener('click',(e)=>{ if(e.target===b) close();});
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close();});
    })();

    /* ===== Toggle filtres (MOBILE) ===== */
    (function(){
      const panel  = document.getElementById('mobile-advanced-filters');
      const btn    = document.getElementById('btn-search-submit');
      const sw     = document.getElementById('switch-advanced');
      const qDesk  = document.getElementById('q-desktop');
      const qMob   = document.getElementById('q-mobile');

      const isMobile = () => window.matchMedia('(max-width: 640px)').matches;

      function syncQState(){
        if (isMobile()){
          if(qDesk) qDesk.disabled = true;
          if(qMob)  qMob.disabled  = false;
        }else{
          if(qDesk) qDesk.disabled = false;
          if(qMob)  qMob.disabled  = true;
        }
      }

      const openPanel = () => {
        panel.classList.add('is-open');
        panel.setAttribute('aria-hidden','false');
        btn.setAttribute('aria-expanded','true');
        if (sw) sw.checked = true;
      };
      const closePanel = () => {
        panel.classList.remove('is-open');
        panel.setAttribute('aria-hidden','true');
        btn.setAttribute('aria-expanded','false');
        if (sw) sw.checked = false;
      };

      // √âtat initial (inclut 'family')
      const qs = new URLSearchParams(window.location.search);
      const hasFilters = ['q','city','city_id','family','specialty','specialty_id','mode'].some(k=>qs.get(k));
      if (isMobile() && hasFilters) openPanel(); else closePanel();
      syncQState();

      sw && sw.addEventListener('change', function(){
        if (!isMobile()) return;
        this.checked ? openPanel() : closePanel();
      });

      // 1er clic (mobile) = ouvre; 2e = submit
      btn && btn.addEventListener('click', function(e){
        if (!isMobile()) return;
        if (!panel.classList.contains('is-open')){
          e.preventDefault();
          openPanel();
          setTimeout(()=>{ qMob && qMob.focus(); }, 0);
        }
      });

      document.getElementById('advClose')?.addEventListener('click', ()=>{ if (isMobile()) closePanel(); });

      document.addEventListener('click', (e)=>{
        if (!isMobile()) return;
        if (!panel.classList.contains('is-open')) return;
        const inside = e.target.closest('#mobile-advanced-filters') || e.target.closest('#btn-search-submit') || e.target.closest('#switch-advanced');
        if (!inside) closePanel();
      });

      document.addEventListener('keydown', (e)=>{ if (isMobile() && e.key === 'Escape' && panel.classList.contains('is-open')) closePanel(); });

      window.addEventListener('resize', ()=>{
        syncQState();
        if (!isMobile()){
          panel.setAttribute('aria-hidden','false');
        }else{
          sw && (sw.checked ? openPanel() : closePanel());
        }
      });
    })();
  </script>
{% endblock %}
