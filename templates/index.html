{% extends "base.html" %}
{% block title %}Tighri{% endblock %}

{% block extra_css %}
<style>
  :root{--primary:#8B5CF6;--primary-dark:#6D28D9;--ink:#2d1a47;--muted:#4B3869;--bg:#f7f5fa;--card:#fff;--shadow:0 2px 12px rgba(139,92,246,.1);--radius:18px}
  body{background:var(--bg);color:var(--ink)}
  header{background:linear-gradient(90deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;padding:8rem 0 2rem;text-align:center}
  header h1{margin:0 0 .5rem;font-size:3rem;font-weight:700}
  header p{margin:0 auto 1.5rem;max-width:700px;font-size:1.15rem;opacity:.95}
  .search-wrap{max-width:1100px;margin:-2.5rem auto 1rem;padding:0 1rem}

  /* Desktop: barre intacte (colonne en plus pour Famille) */
  .search-bar{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto;gap:.5rem;background:#fff;padding:.5rem;border-radius:999px;box-shadow:var(--shadow)}
  .search-bar select,.search-bar input{border:1.5px solid #e6dcff;border-radius:999px;padding:.7rem .9rem}
  .search-bar button{padding:.75rem 1.25rem;border:none;background:var(--primary);color:#fff;border-radius:999px;font-weight:700}
  .search-bar button:hover{background:var(--primary-dark)}
  @media (max-width:960px){ .search-bar{grid-template-columns:1fr 1fr} }

  /* Mobile: on ne montre que les actions, le reste passe dans le panneau */
  @media (max-width:640px){
    .search-bar{grid-template-columns:1fr;gap:.5rem}
    .desktop-only{display:none !important}
  }
  .search-actions{display:flex;align-items:center;gap:.5rem}
  .btn-icon{display:inline-flex;align-items:center;gap:.4rem}
  .btn-icon svg{width:16px;height:16px}

  /* Panneau avancé MOBILE-ONLY (q + ville + famille + spécialité + mode) */
  @media (max-width:640px){
    #mobile-advanced-filters{
      overflow:hidden;max-height:0;opacity:0;transform:translateY(-4px);
      transition:max-height .28s ease,opacity .25s ease,transform .25s ease;
      background:#fff;border-radius:16px;padding:0 .5rem;box-shadow:var(--shadow)
    }
    #mobile-advanced-filters.is-open{max-height:600px;opacity:1;transform:translateY(0);padding:.5rem}
    #mobile-advanced-filters .adv-stack{display:grid;grid-template-columns:1fr;gap:.5rem}
    .adv-head{display:flex;justify-content:flex-end}
    .adv-close{border:none;background:transparent;font-size:1.25rem;line-height:1;padding:.25rem .5rem;cursor:pointer;color:#6D28D9}
  }
  @media (min-width:641px){
    #mobile-advanced-filters{display:contents}
    .mobile-only{display:none !important}
  }

  /* Sections */
  .sections{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin:3rem 0;padding:0 2rem}
  .section{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:2.5rem;min-width:320px;max-width:400px;flex:1 1 320px;text-align:center}
  .section h2{color:var(--primary);margin:0 0 1rem}
  .section p{color:var(--muted);margin:0 0 1.5rem}
  .section a{display:inline-block;background:var(--primary);color:#fff;padding:1rem 2rem;border-radius:30px;text-decoration:none;font-weight:700}
  .section a:hover{background:var(--primary-dark)}

  /* Grilles pros */
  .featured{max-width:1200px;margin:0 auto 3rem;padding:0 2rem}
  .featured h3{color:#6D28D9;margin:0 0 1.5rem;text-align:center;font-size:2rem}
  .professionals{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:1.25rem;justify-items:center}
  @media (max-width:1024px){ .professionals{grid-template-columns:repeat(2,minmax(260px,1fr))} }
  @media (max-width:640px){ .professionals{grid-template-columns:1fr} }
  .professional-card{background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(139,92,246,.08);padding:1.25rem;min-width:260px;max-width:340px;width:100%;text-align:center}
  .professional-card .avatar-box{width:96px;height:96px;border-radius:50%;overflow:hidden;background:#eee;margin:0 auto .85rem}
  .professional-card .avatar-img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;cursor:zoom-in}
  .professional-card h4{margin:.5rem 0 .2rem;color:#6D28D9}
  .professional-card p{color:#4B3869;font-size:.95rem;margin:.35rem 0}
  .professional-card a{color:var(--primary);text-decoration:none;font-weight:600}
  .professional-card a:hover{text-decoration:underline}

  /* Bandeau autre pros */
  .strip{max-width:1200px;margin:0 auto 4rem;padding:0 2rem}
  .strip h3{color:#6D28D9;margin:0 0 1rem;font-size:1.5rem}
  .hscroll{display:flex;gap:1rem;overflow-x:auto;padding-bottom:.5rem;scroll-snap-type:x mandatory}
  .hscroll::-webkit-scrollbar{height:8px}.hscroll::-webkit-scrollbar-thumb{background:#d8cfff;border-radius:999px}
  .card-mini{scroll-snap-align:start;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(139,92,246,.08);padding:1rem;min-width:240px;max-width:240px;text-align:center;flex:0 0 auto}
  .card-mini .avatar-box{width:84px;height:84px;border-radius:50%;overflow:hidden;background:#eee;margin:0 auto .6rem}
  .card-mini .avatar-img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .card-mini h4{margin:.4rem 0 .1rem;color:#6D28D9;font-size:1rem}
  .card-mini p{margin:0;color:#4B3869;font-size:.9rem}

  /* Badges (home) */
  .tg-badges{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;margin:.25rem 0}
  .tg-badge{display:inline-block;font-size:.75rem;font-weight:700;padding:.2rem .55rem;border-radius:999px}
  .tg-badge.tighri{background:#8B5CF6;color:#fff}
  .tg-badge.anthecc{background:#22c55e;color:#fff}
  .tg-badge.sm{font-size:.68rem;padding:.15rem .45rem}

  /* Thumbs secondaires (home) */
  .thumbs{display:flex;gap:.35rem;justify-content:center;margin:.35rem 0 .2rem}
  .thumb{width:40px;height:40px;border-radius:8px;overflow:hidden;background:#eee}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}

  /* À propos / services / contact */
  .about-section{background:#fff;padding:4rem 2rem;margin:3rem 0}
  .about-container{max-width:1200px;margin:0 auto;text-align:center}
  .about-section h2{color:var(--primary);font-size:2.2rem;margin:0 0 1rem}
  .about-section p{color:#4B3869;font-size:1.05rem;line-height:1.8;max-width:800px;margin:0 auto 1.25rem}
  .services-section{padding:4rem 2rem;background:var(--bg)}
  .services-container{max-width:1200px;margin:0 auto}
  .services-section h2{color:var(--primary);font-size:2.2rem;text-align:center;margin:0 0 2rem}
  .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.25rem}
  .service-card{background:#fff;padding:2rem;border-radius:14px;box-shadow:0 2px 8px rgba(139,92,246,.08);text-align:center}
  .service-card h3{color:#6D28D9;margin:.25rem 0 1rem}
  .service-card p{color:#4B3869;margin:0}
  .contact-section{background:var(--primary);color:#fff;padding:4rem 2rem;text-align:center}
  .contact-container{max-width:800px;margin:0 auto}
  .contact-section h2{font-size:2rem;margin:0 0 1rem}
  .contact-section p{font-size:1.05rem;margin:0 0 1.25rem;opacity:.95}
  .contact-info{display:flex;justify-content:center;gap:2rem;flex-wrap:wrap}
  .contact-item{display:flex;flex-direction:column;align-items:center;gap:.35rem}
  .contact-item strong{font-size:1.05rem}
  .contact-actions{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-top:1.25rem}
  .contact-btn{display:inline-flex;align-items:center;gap:.5rem;background:#fff;color:#6D28D9;border:2px solid #fff;padding:.8rem 1.2rem;border-radius:999px;text-decoration:none;font-weight:700;box-shadow:0 2px 8px rgba(139,92,246,.18);transition:.2s}
  .contact-btn:hover{transform:translateY(-2px);background:#f1e9ff;border-color:#8B5CF6}
  .contact-badge{display:inline-block;font-weight:700;padding:.3rem .7rem;border-radius:999px;background:#ffffff20;border:1px solid #ffffff50}

  /* Lightbox */
  .lightbox-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
  .lightbox-backdrop.is-open{display:flex}
  .lightbox-img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .lightbox-close{position:absolute;top:10px;right:10px;border:none;background:#fff;border-radius:999px;padding:.4rem .6rem;cursor:pointer}
</style>
{% endblock %}

{% block content %}
  <header id="top">
    <h1>{{ t('home.title','Tighri') }}</h1>
    <p>{{ t('home.tagline','La plateforme marocaine pour prendre rendez-vous avec des psychologues, thérapeutes et coachs certifiés') }}</p>
  </header>

  <div class="search-wrap">
    {# Formulaire ... (inchangé) #}
    <!-- ... (tout le bloc form de ta version reste inchangé) ... -->
    <form id="tighri-search-form" class="search-bar" method="get" action="{{ url_for('professionals') }}">
      <!-- (contenu identique à ta version, non répété ici pour compacité) -->
      <!-- garde exactement ton formulaire tel quel -->
      {{- caller() if false -}}
      <!-- NB: rien d'autre ne change dans ce formulaire -->
      <!-- ... -->
    </form>
  </div>

  <div class="sections">
    <!-- sections patient/pro (inchangé) -->
    <!-- ... -->
  </div>

  <div class="featured">
    <h3>{{ t('featured.title','Professionnels en vedette') }}</h3>
    {% set grid = top_professionals if top_professionals is defined else professionals %}
    <div class="professionals">
      {% for professional in grid %}
        <div class="professional-card">
          <div class="avatar-box">
            <img class="avatar-img js-zoom"
                 src="{{ url_for('profile_photo', professional_id=professional.id) }}"
                 data-full="{{ url_for('profile_photo', professional_id=professional.id) }}"
                 alt="{{ t('alt.profile_photo','Photo de') }} {{ professional.name|e }}"
                 width="96" height="96" loading="lazy"
                 onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Photo';">
          </div>

          {# ⇩⇩ miniatures secondaires si dispo ⇩⇩ #}
          {% set has2 = professional.image_url2 %}
          {% set has3 = professional.image_url3 %}
          {% if has2 or has3 %}
            <div class="thumbs" aria-label="Galerie">
              {% if has2 %}
              <div class="thumb">
                <img class="js-zoom"
                  src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
                  data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
                  alt="{{ professional.name|e }} — photo 2" loading="lazy"
                  onerror="this.style.display='none'">
              </div>
              {% endif %}
              {% if has3 %}
              <div class="thumb">
                <img class="js-zoom"
                  src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
                  data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
                  alt="{{ professional.name|e }} — photo 3" loading="lazy"
                  onerror="this.style.display='none'">
              </div>
              {% endif %}
            </div>
          {% endif %}

          <h4>{{ professional.name }}</h4>

          <p>{% if professional.specialty %}{{ professional.specialty }}{% elif professional.primary_specialty %}{{ professional.primary_specialty.name }}{% else %}{{ t('labels.professional','Professionnel') }}{% endif %}</p>

          {% if professional.certified_tighri or professional.approved_anthecc %}
            <div class="tg-badges" aria-label="Badges">
              {% if professional.certified_tighri %}<span class="tg-badge tighri">Certifié Tighri</span>{% endif %}
              {% if professional.approved_anthecc %}<span class="tg-badge anthecc">ANTHECC</span>{% endif %}
            </div>
          {% endif %}

          <p>
            {% set d = professional.description or '' %}
            {{ d[:80] }}{% if d|length > 80 %}…{% endif %}
          </p>
          <a href="{{ url_for('professional_detail', professional_id=professional.id) }}">{{ t('btn.view_profile','Voir le profil') }}</a>
        </div>
      {% endfor %}
    </div>
  </div>

  {% set other = (other_professionals if (other_professionals is defined and other_professionals) else (more_professionals if (more_professionals is defined and more_professionals) else [])) %}
  {% if other %}
  <section class="strip">
    <h3>{{ t('other.title','Autres professionnels') }}</h3>
    <div class="hscroll">
      {% for professional in other %}
      <div class="card-mini">
        <div class="avatar-box">
          <img class="avatar-img js-zoom"
               src="{{ url_for('profile_photo', professional_id=professional.id) }}"
               data-full="{{ url_for('profile_photo', professional_id=professional.id) }}"
               alt="{{ t('alt.profile_photo','Photo de') }} {{ professional.name|e }}"
               width="84" height="84" loading="lazy"
               onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=Photo';">
        </div>

        {# ⇩⇩ miniatures secondaires si dispo ⇩⇩ #}
        {% set has2 = professional.image_url2 %}
        {% set has3 = professional.image_url3 %}
        {% if has2 or has3 %}
          <div class="thumbs" aria-label="Galerie">
            {% if has2 %}
              <div class="thumb">
                <img class="js-zoom"
                     src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
                     data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
                     alt="{{ professional.name|e }} — photo 2" loading="lazy"
                     onerror="this.style.display='none'">
              </div>
            {% endif %}
            {% if has3 %}
              <div class="thumb">
                <img class="js-zoom"
                     src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
                     data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
                     alt="{{ professional.name|e }} — photo 3" loading="lazy"
                     onerror="this.style.display='none'">
              </div>
            {% endif %}
          </div>
        {% endif %}

        <h4>{{ professional.name }}</h4>

        {% if professional.certified_tighri or professional.approved_anthecc %}
          <div class="tg-badges" aria-label="Badges">
            {% if professional.certified_tighri %}<span class="tg-badge tighri sm">Tighri</span>{% endif %}
            {% if professional.approved_anthecc %}<span class="tg-badge anthecc sm">ANTHECC</span>{% endif %}
          </div>
        {% endif %}

        <p>{% if professional.specialty %}{{ professional.specialty }}{% elif professional.primary_specialty %}{{ professional.primary_specialty.name }}{% else %}—{% endif %}</p>
        <a href="{{ url_for('professional_detail', professional_id=professional.id) }}" style="color:var(--primary);font-weight:600;text-decoration:none">{{ t('btn.view','Voir') }}</a>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section id="about" class="about-section">
    <!-- inchangé -->
    <!-- ... -->
  </section>

  <section id="services" class="services-section">
    <!-- inchangé -->
    <!-- ... -->
  </section>

  <section id="contact" class="contact-section">
    <!-- inchangé -->
    <!-- ... -->
  </section>

  <div class="lightbox-backdrop" id="lbBackdrop" aria-modal="true" role="dialog">
    <button class="lightbox-close" id="lbClose" aria-label="{{ t('lightbox.close','Fermer') }}">✕</button>
    <img id="lbImg" class="lightbox-img" alt="{{ t('lightbox.zoom_alt','Agrandissement') }}">
  </div>

  <script>
    /* Lightbox (inchangé) */
    (function(){
      const b=document.getElementById('lbBackdrop'), img=document.getElementById('lbImg'), x=document.getElementById('lbClose');
      function open(src){ img.src=src; b.classList.add('is-open'); }
      function close(){ b.classList.remove('is-open'); img.src=''; }
      document.addEventListener('click',(e)=>{ const t=e.target.closest('.js-zoom'); if(!t) return;
        e.preventDefault(); open(t.getAttribute('data-full')||t.src||'');});
      x.addEventListener('click',close); b.addEventListener('click',(e)=>{ if(e.target===b) close();});
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close();});
    })();

    /* Toggle filtres (inchangé) */
    (function(){
      /* ... tout ton JS existant ici ... */
    })();
  </script>
{% endblock %}
