{% extends "base.html" %}
{% block title %}Modifier mon profil professionnel{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="h4 mb-1">Mon profil professionnel</h1>
  <div class="mb-3">
    <a href="{{ url_for('professional_dashboard') }}" class="link-secondary" style="font-size:.95rem;">← Retour au tableau de bord</a>
  </div>

  <!-- PATCH #1 : action explicite + on laisse la validation HTML5 -->
  <form id="pro-edit-form" method="post" action="{{ url_for('professional_edit_profile') }}">
    <!-- PATCH #2 : CSRF robuste (Flask-WTF OU helper custom) -->
    {% if form is defined %}
      {{ form.csrf_token }}
    {% elif csrf_token is defined %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}

    <!-- Legacy / « autre ville » -->
    <input type="hidden" name="location" id="location_hidden">
    <!-- Création si absente (contrat fix) -->
    <input type="hidden" name="new_specialty_name" id="new_specialty_name">
    <input type="hidden" name="new_specialty_family" id="new_specialty_family">

    <div class="row g-3">
      <!-- Identité -->
      <div class="col-md-6">
        <label class="form-label">Nom / Affichage public</label>
        <input name="name" class="form-control" value="{{ professional.name or '' }}" required>
      </div>

      <!-- ===== Famille + Spécialités (via category) ===== -->
      {% if (families is defined and families) and (specialties is defined and specialties) %}
        <div class="col-md-6">
          <label class="form-label">Famille (catégorie)</label>
          <select name="family" id="edit_family_name" class="form-select">
            <option value="">Toutes les familles</option>
            {% for f in families %}
              <option value="{{ f.name }}">{{ f.name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Optionnel : filtre la/les spécialité(s) ci-dessous.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Spécialité principale</label>
          <div class="input-group">
            <select name="primary_specialty_id" id="edit_primary_specialty_id" class="form-select">
              <option value="">Choisir une spécialité</option>
              {% for s in specialties %}
                <option value="{{ s.id }}"
                        data-category="{{ s.category or '' }}"
                        {% if professional.primary_specialty_id is defined and professional.primary_specialty_id == s.id %}selected{% endif %}>
                  {{ s.name }}
                </option>
              {% endfor %}
            </select>
            <input id="spec_other" class="form-control" placeholder="Autre spécialité (si non listée)">
          </div>
          <div class="form-text">Si vous saisissez “Autre spécialité”, laissez le menu vide : elle sera créée.</div>
        </div>

        <div class="col-12">
          {% set _sec_ids = (professional.specialties | map(attribute='id') | list) if professional.specialties else [] %}
          <label class="form-label">Spécialités secondaires (optionnel)</label>
          <select name="specialty_ids" id="edit_secondary_specialty_ids" class="form-select" multiple size="6">
            {% for s in specialties %}
              <option value="{{ s.id }}"
                      data-category="{{ s.category or '' }}"
                      {% if s.id in _sec_ids %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">Maintenez Ctrl (Windows) ou ⌘ (Mac) pour choisir plusieurs éléments.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Spécialité (texte libre — optionnel)</label>
          <input name="specialty" class="form-control" value="{{ professional.specialty or '' }}" placeholder="Psychologue, Thérapeute, Coach…" list="specialties_list">
          <datalist id="specialties_list">
            {% if ALL_SPECIALTIES is defined %}
              {% for s in ALL_SPECIALTIES %}
                <option value="{{ s }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
          <div class="form-text">Texte affiché; sinon, nous afficherons la spécialité principale.</div>
        </div>
      {% else %}
        <!-- Fallback: pas de listes ORM -->
        <div class="col-md-6">
          <label class="form-label">Spécialité</label>
          <input name="specialty" class="form-control" value="{{ professional.specialty or '' }}" placeholder="Psychologue, Thérapeute, Coach…" list="specialties_list">
          <datalist id="specialties_list">
            {% if ALL_SPECIALTIES is defined %}
              {% for s in ALL_SPECIALTIES %}
                <option value="{{ s }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
      {% endif %}

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea name="description" rows="3" class="form-control" placeholder="Présentation…">{{ professional.description or '' }}</textarea>
      </div>

      <!-- ===== Ville ===== -->
      {% if cities is defined and cities %}
        <div class="col-md-6">
          <label class="form-label">Ville (sélection ou “Autre”)</label>
          <div class="input-group">
            <select name="city_id" id="edit_city_id" class="form-select">
              <option value="">Choisir une ville</option>
              {% for c in cities %}
                <option value="{{ c.id }}" {% if professional.city_id is defined and professional.city_id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
            <input id="city_other" class="form-control" placeholder="Autre ville (si non listée)">
          </div>
          <div class="form-text">Si vous entrez une ville “Autre”, laissez le menu vide.</div>
        </div>
      {% else %}
        <div class="col-md-6">
          <label class="form-label">Ville</label>
          <input name="location" class="form-control" value="{{ professional.location or '' }}" placeholder="Casablanca" list="cities_list">
          <datalist id="cities_list">
            {% if ALL_CITIES is defined %}
              {% for c in ALL_CITIES %}
                <option value="{{ c }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
      {% endif %}

      <div class="col-md-6">
        <label class="form-label">Adresse précise</label>
        <input name="address" class="form-control" value="{{ professional.address or '' }}" placeholder="N°, rue, quartier…">
      </div>

      <div class="col-md-6">
        <label class="form-label">Latitude</label>
        <input name="latitude" class="form-control" value="{{ professional.latitude if professional.latitude is not none else '' }}" placeholder="33.5">
      </div>
      <div class="col-md-6">
        <label class="form-label">Longitude</label>
        <input name="longitude" class="form-control" value="{{ professional.longitude if professional.longitude is not none else '' }}" placeholder="-7.6">
      </div>

      <!-- Téléphone -->
      <div class="col-md-6">
        <label class="form-label">Téléphone</label>
        <input name="phone" class="form-control" value="{{ professional.phone or '' }}" placeholder="06...">
      </div>

      <!-- PATCH #3 : Prix (sécurisé HTML5) -->
      <div class="col-md-6">
        <label class="form-label">Prix consultation (MAD)</label>
        <input
          name="consultation_fee"
          type="number"
          class="form-control"
          inputmode="numeric"
          min="0"
          step="1"
          required
          value="{{ professional.consultation_fee if professional.consultation_fee is not none else 0 }}"
          placeholder="Ex: 300"
        >
        <div class="form-text">Mettez <strong>0</strong> si gratuit.</div>
      </div>

      <!-- Types de consultation -->
      {% set types = (professional.consultation_types or 'cabinet').split(',') %}
      <div class="col-12">
        <label class="form-label d-block">Types de consultation</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="cabinet" id="t_cab" {% if 'cabinet' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_cab">Cabinet</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="visio" id="t_visio" {% if 'visio' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_visio">Visio</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="domicile" id="t_home" {% if 'domicile' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_home">À domicile</label>
        </div>
      </div>

      <!-- Liens sociaux -->
      <div class="col-12">
        <label class="form-label">Liens sociaux</label>
        <div class="row g-2">
          <div class="col-md-6"><input name="facebook_url"  class="form-control" placeholder="Facebook (URL complète)"  value="{{ professional.facebook_url  or '' }}"></div>
          <div class="col-md-6"><input name="instagram_url" class="form-control" placeholder="Instagram (URL complète)" value="{{ professional.instagram_url or '' }}"></div>
          <div class="col-md-6"><input name="tiktok_url"    class="form-control" placeholder="TikTok (URL complète)"    value="{{ professional.tiktok_url    or '' }}"></div>
          <div class="col-md-6"><input name="youtube_url"   class="form-control" placeholder="YouTube (URL complète)"   value="{{ professional.youtube_url   or '' }}"></div>
        </div>
        <div class="form-text">
          Toute modification des liens sociaux nécessite une <strong>ré-approbation</strong> par l’administrateur.
          Statut actuel :
          <span class="badge bg-{{ 'success' if professional.social_links_approved else 'secondary' }}">
            {{ 'approuvé' if professional.social_links_approved else 'en attente / non approuvé' }}
          </span>
        </div>
      </div>

      <!-- Durée / buffer -->
      <div class="col-md-6">
        <label class="form-label">Durée d’une séance (minutes)</label>
        <input name="consultation_duration_minutes" type="number" min="5" max="240" step="5" class="form-control"
               value="{{ professional.consultation_duration_minutes if professional.consultation_duration_minutes is not none else 45 }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Délai entre deux séances (minutes)</label>
        <input name="buffer_between_appointments_minutes" type="number" min="0" max="120" step="5" class="form-control"
               value="{{ professional.buffer_between_appointments_minutes if professional.buffer_between_appointments_minutes is not none else 15 }}">
      </div>

      <!-- Lien Maps -->
      <div class="col-12">
        {% set maps_q = None %}
        {% if professional.latitude is not none and professional.longitude is not none %}
          {% set maps_q = (professional.latitude|string) ~ ',' ~ (professional.longitude|string) %}
        {% elif professional.address %}
          {% set maps_q = professional.address %}
        {% elif professional.city %}
          {% set maps_q = professional.city.name %}
        {% elif professional.location %}
          {% set maps_q = professional.location %}
        {% endif %}
        {% if maps_q %}
          <a class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener"
             href="https://www.google.com/maps?q={{ maps_q|replace(' ','+') }}">
            Voir sur Google Maps
          </a>
        {% endif %}
      </div>
    </div>

    <button class="btn btn-primary mt-3">Enregistrer</button>
    <a href="{{ url_for('professional_dashboard') }}" class="btn btn-outline-secondary mt-3">Annuler</a>
  </form>
</div>

{% if (families is defined and families) and (specialties is defined and specialties) %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const famSel    = document.getElementById('edit_family_name');
  const primary   = document.getElementById('edit_primary_specialty_id');
  const secondary = document.getElementById('edit_secondary_specialty_ids');

  function filterByFamily(){
    const cat = (famSel?.value || '').trim();
    [primary, secondary].forEach(function(sel){
      if(!sel) return;
      let firstVisible = null;
      Array.from(sel.options).forEach(function(opt){
        if(!opt.value) return;
        const ok = !cat || (String(opt.dataset.category||'') === cat);
        opt.hidden = !ok;
        if(ok && !firstVisible) firstVisible = opt;
      });
      if(sel.selectedOptions.length){
        const anyVisibleSelected = Array.from(sel.selectedOptions).some(o => !o.hidden);
        if(!anyVisibleSelected) sel.value = '';
      }
    });
  }

  const selected = primary?.selectedOptions?.[0];
  if(selected && selected.dataset.category){
    famSel.value = selected.dataset.category;
  }
  filterByFamily();
  famSel?.addEventListener('change', filterByFamily);
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form       = document.getElementById('pro-edit-form');

  const primarySel = document.getElementById('edit_primary_specialty_id');
  const specOther  = document.getElementById('spec_other');
  const famSelName = document.getElementById('edit_family_name');
  const newName    = document.getElementById('new_specialty_name');
  const newFamily  = document.getElementById('new_specialty_family');

  const citySelect = document.getElementById('edit_city_id');
  const cityOther  = document.getElementById('city_other');
  const locHidden  = document.getElementById('location_hidden');

  form && form.addEventListener('submit', function(){
    const other = (specOther?.value || '').trim();
    if (primarySel && !primarySel.value && other){
      newName  && (newName.value   = other);
      newFamily&& (newFamily.value = (famSelName?.value || '').trim());
    } else {
      newName  && (newName.value   = '');
      newFamily&& (newFamily.value = '');
    }

    const otherCity = (cityOther?.value || '').trim();
    if (citySelect && !citySelect.value && otherCity){
      locHidden && (locHidden.value = otherCity);
    } else {
      locHidden && (locHidden.value = '');
    }
  });
});
</script>
{% endblock %}
