{% extends "base.html" %}
{% block title %}Modifier mon profil professionnel{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="h4 mb-3">Mon profil professionnel</h1>

  <form id="pro-edit-form" method="post">
    {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

    <!-- pour “Autre ville” quand la liste existe -->
    <input type="hidden" name="location" id="location_hidden">

    <div class="row g-3">
      <!-- Identité -->
      <div class="col-md-6">
        <label class="form-label">Nom / Affichage public</label>
        <input name="name" class="form-control" value="{{ professional.name or '' }}" required>
      </div>

      <!-- Famille + Spécialité par ID si listes dispo, sinon fallback datalist texte -->
      {% if (families is defined and families) and (specialties is defined and specialties) %}
        <div class="col-md-6">
          <label class="form-label">Famille</label>
          <select name="family_id" id="edit_family_id" class="form-select">
            <option value="">Toutes les familles</option>
            {% for f in families %}
              <option value="{{ f.id }}">{{ f.name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Optionnel : sert à filtrer la liste ci-dessous.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Spécialité (sélection ou texte libre)</label>
          <select name="primary_specialty_id" id="edit_specialty_id" class="form-select">
            <option value="">Choisir une spécialité</option>
            {% for s in specialties %}
              <option value="{{ s.id }}"
                      data-family="{{ s.family_id or '' }}"
                      {% if professional.primary_specialty_id is defined and professional.primary_specialty_id == s.id %}selected{% endif %}>
                {{ s.name }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">Si vous choisissez dans cette liste, le texte libre ci-dessous peut rester vide.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Spécialité (texte libre — optionnel)</label>
          <input name="specialty" class="form-control" value="{{ professional.specialty or '' }}" placeholder="Psychologue, Thérapeute, Coach…" list="specialties_list">
          <datalist id="specialties_list">
            {% if ALL_SPECIALTIES is defined %}
              {% for s in ALL_SPECIALTIES %}
                <option value="{{ s }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
      {% else %}
        <div class="col-md-6">
          <label class="form-label">Spécialité</label>
          <input name="specialty" class="form-control" value="{{ professional.specialty or '' }}" placeholder="Psychologue, Thérapeute, Coach…" list="specialties_list">
          <datalist id="specialties_list">
            {% if ALL_SPECIALTIES is defined %}
              {% for s in ALL_SPECIALTIES %}
                <option value="{{ s }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
      {% endif %}

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea name="description" rows="3" class="form-control" placeholder="Présentation…">{{ professional.description or '' }}</textarea>
      </div>

      <!-- Localisation (contrat fix : city_id OU “autre ville” -> location) -->
      {% if cities is defined and cities %}
        <div class="col-md-6">
          <label class="form-label">Ville (sélection ou “Autre”)</label>
          <div class="input-group">
            <select name="city_id" id="edit_city_id" class="form-select">
              <option value="">Choisir une ville</option>
              {% for c in cities %}
                <option value="{{ c.id }}" {% if professional.city_id is defined and professional.city_id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
            <input id="city_other" class="form-control" placeholder="Autre ville (si non listée)">
          </div>
          <div class="form-text">Si vous entrez une ville “Autre”, laissez le menu vide.</div>
        </div>
      {% else %}
        <div class="col-md-6">
          <label class="form-label">Ville</label>
          <input name="location" class="form-control" value="{{ professional.location or '' }}" placeholder="Casablanca" list="cities_list">
          <datalist id="cities_list">
            {% if ALL_CITIES is defined %}
              {% for c in ALL_CITIES %}
                <option value="{{ c }}"></option>
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
      {% endif %}

      <div class="col-md-6">
        <label class="form-label">Adresse précise</label>
        <input name="address" class="form-control" value="{{ professional.address or '' }}" placeholder="N°, rue, quartier…">
      </div>

      <div class="col-md-6">
        <label class="form-label">Latitude</label>
        <input name="latitude" class="form-control" value="{{ professional.latitude if professional.latitude is not none else '' }}" placeholder="33.5">
      </div>
      <div class="col-md-6">
        <label class="form-label">Longitude</label>
        <input name="longitude" class="form-control" value="{{ professional.longitude if professional.longitude is not none else '' }}" placeholder="-7.6">
      </div>

      <!-- Téléphone -->
      <div class="col-md-6">
        <label class="form-label">Téléphone</label>
        <input name="phone" class="form-control" value="{{ professional.phone or '' }}" placeholder="06...">
      </div>

      <!-- Prix -->
      <div class="col-md-6">
        <label class="form-label">Prix consultation (MAD)</label>
        <input name="consultation_fee" class="form-control" value="{{ professional.consultation_fee if professional.consultation_fee is not none else '' }}" placeholder="Ex: 300">
      </div>

      <!-- Types de consultation -->
      {% set types = (professional.consultation_types or 'cabinet').split(',') %}
      <div class="col-12">
        <label class="form-label d-block">Types de consultation</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="cabinet" id="t_cab" {% if 'cabinet' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_cab">Cabinet</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="visio" id="t_visio" {% if 'visio' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_visio">Visio</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="consultation_types" value="domicile" id="t_home" {% if 'domicile' in types %}checked{% endif %}>
          <label class="form-check-label" for="t_home">À domicile</label>
        </div>
        <div class="form-text">Cochez un ou plusieurs types.</div>
      </div>

      <!-- Liens sociaux -->
      <div class="col-12">
        <label class="form-label">Liens sociaux</label>
        <div class="row g-2">
          <div class="col-md-6">
            <input name="facebook_url" class="form-control" placeholder="Facebook (URL complète)" value="{{ professional.facebook_url or '' }}">
          </div>
          <div class="col-md-6">
            <input name="instagram_url" class="form-control" placeholder="Instagram (URL complète)" value="{{ professional.instagram_url or '' }}">
          </div>
          <div class="col-md-6">
            <input name="tiktok_url" class="form-control" placeholder="TikTok (URL complète)" value="{{ professional.tiktok_url or '' }}">
          </div>
          <div class="col-md-6">
            <input name="youtube_url" class="form-control" placeholder="YouTube (URL complète)" value="{{ professional.youtube_url or '' }}">
          </div>
        </div>
        <div class="form-text">
          Toute modification des liens sociaux nécessite une <strong>ré-approbation</strong> par l’administrateur.
          Statut actuel :
          <span class="badge bg-{{ 'success' if professional.social_links_approved else 'secondary' }}">
            {{ 'approuvé' if professional.social_links_approved else 'en attente / non approuvé' }}
          </span>
        </div>
      </div>

      <!-- Durée / buffer -->
      <div class="col-md-6">
        <label class="form-label">Durée d’une séance (minutes)</label>
        <input name="consultation_duration_minutes" type="number" min="5" max="240" step="5" class="form-control"
               value="{{ professional.consultation_duration_minutes if professional.consultation_duration_minutes is not none else 45 }}">
        <div class="form-text">Par défaut 45 min. Sert au calcul des créneaux.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Délai entre deux séances (minutes)</label>
        <input name="buffer_between_appointments_minutes" type="number" min="0" max="120" step="5" class="form-control"
               value="{{ professional.buffer_between_appointments_minutes if professional.buffer_between_appointments_minutes is not none else 15 }}">
        <div class="form-text">Par défaut 15 min.</div>
      </div>

      <!-- Voir sur Maps -->
      <div class="col-12">
        {% set maps_q = None %}
        {% if professional.latitude and professional.longitude %}
          {% set maps_q = (professional.latitude|string) ~ ',' ~ (professional.longitude|string) %}
        {% elif professional.address %}
          {% set maps_q = professional.address %}
        {% endif %}
        {% if maps_q %}
          <a class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener"
             href="https://www.google.com/maps?q={{ maps_q|replace(' ','+') }}">
            Voir sur Google Maps
          </a>
        {% endif %}
      </div>
    </div>

    <button class="btn btn-primary mt-3">Enregistrer</button>
    <a href="{{ url_for('professional_dashboard') }}" class="btn btn-outline-secondary mt-3">Annuler</a>
  </form>
</div>

<!-- Galerie (optionnel) : en dehors du formulaire (pas traitée côté backend) -->
<div class="col-12">
  <label class="form-label">Galerie (photos supplémentaires)</label>
  <div class="row g-2">
    <div class="col-md-6">
      <input name="image_url2" class="form-control" type="url"
             placeholder="https://... (Photo 2)"
             value="{{ professional.image_url2 if professional.image_url2 is defined and professional.image_url2 else '' }}">
    </div>
    <div class="col-md-6">
      <input name="image_url3" class="form-control" type="url"
             placeholder="https://... (Photo 3)"
             value="{{ professional.image_url3 if professional.image_url3 is defined and professional.image_url3 else '' }}">
    </div>
  </div>
  <div class="form-text">Laissez vide si vous n’utilisez pas ces emplacements.</div>
</div>

<!-- Filtrage client famille -> spécialité + pré-sélection auto de la famille -->
{% if (families is defined and families) and (specialties is defined and specialties) %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  var fam = document.getElementById('edit_family_id');
  var spec = document.getElementById('edit_specialty_id');
  if(!fam || !spec) return;

  function filterSpecs(){
    var fid = fam.value || '';
    Array.from(spec.options).forEach(function(opt){
      if(!opt.value) return;
      var ok = !fid || (String(opt.dataset.family||'') === String(fid));
      opt.hidden = !ok;
    });
    if(spec.selectedOptions.length && spec.selectedOptions[0].hidden){
      spec.value = '';
    }
  }

  // pré-sélection famille depuis la spécialité existante
  var selected = spec.selectedOptions.length ? spec.selectedOptions[0] : null;
  if(selected && selected.dataset.family){
    fam.value = selected.dataset.family;
  }
  filterSpecs();
  fam.addEventListener('change', filterSpecs);
});
</script>
{% endif %}

<!-- “Autre ville” -> envoi dans name=location si aucune city_id -->
{% if cities is defined and cities %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  var form = document.getElementById('pro-edit-form');
  var citySelect = document.getElementById('edit_city_id');
  var cityOther  = document.getElementById('city_other');
  var locHidden  = document.getElementById('location_hidden');

  if(form && citySelect && cityOther && locHidden){
    form.addEventListener('submit', function(){
      if(!citySelect.value && cityOther.value.trim()){
        locHidden.value = cityOther.value.trim();
      }else{
        locHidden.value = '';
      }
    });
  }
});
</script>
{% endif %}
{% endblock %}
