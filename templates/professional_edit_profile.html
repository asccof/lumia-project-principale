<!-- templates/professional_edit_profile.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modifier mon profil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('index') }}">Lumia</a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link" href="{{ url_for('professional_dashboard') }}">Dashboard</a>
      <a class="nav-link" href="{{ url_for('logout') }}">Déconnexion</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h1 class="mb-4">Modifier mon profil</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'warning' if category=='error' else category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('professional_edit_profile') }}" class="card p-4 bg-white shadow-sm">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nom</label>
        <input type="text" name="name" class="form-control" value="{{ professional.name or '' }}">
      </div>

      <div class="col-md-6">
        <label class="form-label">Spécialité</label>
        <input type="text" name="specialty" class="form-control" value="{{ professional.specialty or '' }}">
        <!-- alias accepté côté serveur: name="category" -->
      </div>

      <!-- Remplace l'ancienne "Ville" par une adresse complète -->
      <div class="col-12">
        <label class="form-label">Adresse complète</label>
        <input type="text" name="address" class="form-control"
               placeholder="Ex: 123 Boulevard Zerktouni, Maarif, Casablanca 20000"
               value="{{ professional.address or '' }}">
        <div class="form-text">
          Saisis l’adresse exacte de ton cabinet / lieu d’exercice.
        </div>
      </div>

      <!-- Latitude / Longitude avec bouton 'Me localiser' -->
      <div class="col-md-5">
        <label class="form-label">Latitude</label>
        <input type="text" inputmode="decimal" name="latitude" id="latInput" class="form-control"
               placeholder="33.5731"
               value="{{ professional.latitude if professional.latitude is not none else '' }}">
      </div>
      <div class="col-md-5">
        <label class="form-label">Longitude</label>
        <input type="text" inputmode="decimal" name="longitude" id="lngInput" class="form-control"
               placeholder="-7.5898"
               value="{{ professional.longitude if professional.longitude is not none else '' }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-outline-primary w-100" id="btnLocate">
          Me localiser
        </button>
      </div>

      <!-- Lien Google Maps (prévisualisation) -->
      <div class="col-12">
        <label class="form-label">Prévisualisation</label>
        <div>
          <a id="gmapsLink" class="link-primary" target="_blank" rel="noopener"
             href="#">
            Ouvrir dans Google Maps
          </a>
        </div>
        <div class="form-text">
          Le lien utilise la latitude/longitude si présentes, sinon l’adresse.
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Tarif de consultation (MAD)</label>
        <input type="text" name="consultation_fee" class="form-control" value="{{ professional.consultation_fee or '' }}">
        <!-- alias accepté: name="price" -->
      </div>

      <div class="col-md-6">
        <label class="form-label">Téléphone</label>
        <input type="text" name="phone" class="form-control" value="{{ professional.phone or '' }}">
      </div>

      <div class="col-md-6">
        <label class="form-label">Années d'expérience</label>
        <input type="number" name="experience_years" class="form-control" value="{{ professional.experience_years or 0 }}">
      </div>

      <div class="col-12">
        <label class="form-label">URL de l’image</label>
        <input type="text" name="image_url" class="form-control" value="{{ professional.image_url or '' }}">
      </div>

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea name="description" class="form-control" rows="5">{{ professional.description or '' }}</textarea>
      </div>
    </div>

    <div class="d-flex gap-2 mt-4">
      <a class="btn btn-outline-secondary" href="{{ url_for('professional_dashboard') }}">Annuler</a>
      <button type="submit" class="btn btn-primary">Enregistrer</button>
    </div>
  </form>
</div>

<script>
  // Construit le lien Google Maps selon lat/lng ou adresse
  function updateGmapsLink() {
    const lat = document.getElementById('latInput').value.trim();
    const lng = document.getElementById('lngInput').value.trim();
    const address = document.querySelector('input[name="address"]').value.trim();
    const a = document.getElementById('gmapsLink');

    if (lat && lng) {
      a.href = `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
    } else if (address) {
      a.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    } else {
      a.href = '#';
    }
  }

  document.getElementById('latInput').addEventListener('input', updateGmapsLink);
  document.getElementById('lngInput').addEventListener('input', updateGmapsLink);
  document.querySelector('input[name="address"]').addEventListener('input', updateGmapsLink);
  updateGmapsLink();

  // Bouton "Me localiser" (remplit lat/lng via le navigateur)
  document.getElementById('btnLocate').addEventListener('click', function () {
    if (!navigator.geolocation) {
      alert("La géolocalisation n'est pas supportée par ce navigateur.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        document.getElementById('latInput').value = latitude.toFixed(6);
        document.getElementById('lngInput').value = longitude.toFixed(6);
        updateGmapsLink();
      },
      (err) => {
        alert("Impossible d'obtenir votre position : " + err.message);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
</script>
</body>
</html>
