{% extends "base.html" %}
{% block title %}{{ professional.name }} ‚Äî Tighri{% endblock %}

{% block content %}
<!-- Fil d'Ariane -->
<nav aria-label="breadcrumb" class="py-3 bg-light">
  <div class="container">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Accueil</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('professionals') }}">Professionnels</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ professional.name }}</li>
    </ol>
  </div>
</nav>

<section class="py-4">
  <div class="container">
    <div class="row g-4">
      <!-- Galerie / Photos -->
      <div class="col-lg-5">
        <div class="card shadow-sm">
          <img
            src="{{ url_for('profile_photo', professional_id=professional.id) }}"
            class="img-fluid rounded-top"
            alt="Photo de {{ professional.name }}"
            onerror="this.onerror=null;this.src='https://placehold.co/800x600?text=Photo';"
          >
          {% if professional.image_url2 or professional.image_url3 %}
            <div class="p-3 border-top d-flex gap-2 flex-wrap">
              {% if professional.image_url2 %}
                <img src="{{ professional.image_url2 }}" alt="Photo 2"
                     class="img-thumbnail" style="width:84px;height:84px;object-fit:cover"
                     onerror="this.style.display='none'">
              {% endif %}
              {% if professional.image_url3 %}
                <img src="{{ professional.image_url3 }}" alt="Photo 3"
                     class="img-thumbnail" style="width:84px;height:84px;object-fit:cover"
                     onerror="this.style.display='none'">
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Infos pro + RDV -->
      <div class="col-lg-7">
        <div class="d-flex align-items-center gap-2 mb-2">
          <h1 class="h3 m-0">{{ professional.name }}</h1>
          {% if professional.certified_tighri %}
            <span class="badge text-bg-success">Certifi√© Tighri</span>
          {% endif %}
          {% if professional.approved_anthecc %}
            <span class="badge text-bg-warning">ANTHECC</span>
          {% endif %}
        </div>

        <p class="text-muted mb-2">
          {% if professional.primary_specialty %}{{ professional.primary_specialty.name }}
          {% elif professional.specialty %}{{ professional.specialty }}
          {% else %}Professionnel{% endif %}
          {% if professional.city %} ‚Ä¢ {{ professional.city.name }}
          {% elif professional.location %} ‚Ä¢ {{ professional.location }}{% endif %}
        </p>

        <div class="mb-3 d-flex flex-wrap gap-2">
          {% set types = (professional.consultation_types or '') %}
          {% if 'cabinet' in types %}<span class="badge text-bg-info"><i class="fas fa-building me-1"></i>Cabinet</span>{% endif %}
          {% if 'domicile' in types %}<span class="badge text-bg-success"><i class="fas fa-home me-1"></i>Domicile</span>{% endif %}
          {% if 'en_ligne' in types or 'visio' in types %}<span class="badge text-bg-warning"><i class="fas fa-video me-1"></i>En ligne</span>{% endif %}
          {% if not ('cabinet' in types or 'domicile' in types or 'en_ligne' in types or 'visio' in types) %}
            <span class="badge text-bg-secondary">Types √† pr√©ciser</span>
          {% endif %}
        </div>

        <ul class="list-unstyled small text-muted mb-3">
          {% if professional.experience_years is not none %}
            <li><i class="far fa-clock me-2"></i>{{ professional.experience_years }} an(s) d‚Äôexp√©rience</li>
          {% endif %}
          {% if professional.consultation_fee is not none %}
            <li><i class="fas fa-tag me-2"></i>Tarif indicatif : {{ '%.0f'|format(professional.consultation_fee) }} MAD</li>
          {% endif %}
          {% if professional.phone %}
            <li><i class="fas fa-phone me-2"></i><a href="tel:{{ professional.phone|replace(' ','') }}">{{ professional.phone }}</a></li>
          {% endif %}
          {% if professional.address %}
            <li><i class="fas fa-map-marker-alt me-2"></i>{{ professional.address }}</li>
          {% endif %}
        </ul>

        {% if professional.description %}
          <div class="mb-4">
            <h2 class="h6">Pr√©sentation</h2>
            <p class="mb-0">{{ professional.description }}</p>
          </div>
        {% endif %}

        <!-- Liens sociaux (affich√©s quand approuv√©s) -->
        {% if professional.social_links_approved %}
          <div class="mb-4 d-flex flex-wrap gap-2">
            {% if professional.facebook_url %}<a class="btn btn-outline-secondary btn-sm" target="_blank" href="{{ professional.facebook_url }}"><i class="fab fa-facebook me-1"></i>Facebook</a>{% endif %}
            {% if professional.instagram_url %}<a class="btn btn-outline-secondary btn-sm" target="_blank" href="{{ professional.instagram_url }}"><i class="fab fa-instagram me-1"></i>Instagram</a>{% endif %}
            {% if professional.tiktok_url %}<a class="btn btn-outline-secondary btn-sm" target="_blank" href="{{ professional.tiktok_url }}"><i class="fab fa-tiktok me-1"></i>TikTok</a>{% endif %}
            {% if professional.youtube_url %}<a class="btn btn-outline-secondary btn-sm" target="_blank" href="{{ professional.youtube_url }}"><i class="fab fa-youtube me-1"></i>YouTube</a>{% endif %}
          </div>
        {% endif %}

        <!-- Carte / Maps -->
        {% set maps_q = None %}
        {% if professional.latitude is not none and professional.longitude is not none %}
          {% set maps_q = (professional.latitude|string) ~ ',' ~ (professional.longitude|string) %}
        {% elif professional.address %}
          {% set maps_q = professional.address %}
        {% elif professional.city %}
          {% set maps_q = professional.city.name %}
        {% elif professional.location %}
          {% set maps_q = professional.location %}
        {% endif %}
        {% if maps_q %}
          <a class="btn btn-outline-secondary btn-sm mb-3" target="_blank" rel="noopener" href="https://www.google.com/maps?q={{ maps_q|replace(' ','+') }}">
            <i class="fas fa-map me-1"></i>Voir sur Google Maps
          </a>
        {% endif %}

        <!-- üóìÔ∏è R√©servation : formulaire POST direct vers /book_appointment/<id> -->
        <div class="card mt-2">
          <div class="card-body">
            <h2 class="h6 mb-3">Prendre rendez-vous</h2>
            <form id="bookingForm" method="post" action="{{ url_for('book_appointment', professional_id=professional.id) }}">
              {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

              <div class="row g-3">
                <div class="col-md-5">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="apptDate" name="appointment_date" required min="{{ (cycler).__class__.__mro__[1].__name__ is defined and '' }}">
                  <!-- astuce min non fiable dans Jinja vanilla ; on fixera en JS -->
                </div>
                <div class="col-md-7">
                  <label class="form-label">Cr√©neau horaire</label>
                  <div id="slotGrid" class="d-flex flex-wrap gap-2">
                    <span class="text-muted small">Choisissez une date pour voir les cr√©neaux‚Ä¶</span>
                  </div>
                  <input type="hidden" id="apptTime" name="appointment_time" required>
                </div>

                <div class="col-12">
                  <label class="form-label d-block">Type de consultation</label>
                  <div class="d-flex flex-wrap gap-3">
                    {% set can_cab = 'cabinet' in types %}
                    {% set can_dom = 'domicile' in types %}
                    {% set can_vid = 'en_ligne' in types or 'visio' in types %}
                    <label class="form-check">
                      <input class="form-check-input" type="radio" name="consultation_type" value="cabinet" {% if can_cab %}checked{% endif %} {% if not can_cab %}disabled{% endif %}>
                      <span class="ms-1">Cabinet</span>
                    </label>
                    <label class="form-check">
                      <input class="form-check-input" type="radio" name="consultation_type" value="domicile" {% if not can_dom %}disabled{% endif %}>
                      <span class="ms-1">Domicile</span>
                    </label>
                    <label class="form-check">
                      <input class="form-check-input" type="radio" name="consultation_type" value="en_ligne" {% if not can_vid %}disabled{% endif %}>
                      <span class="ms-1">En ligne</span>
                    </label>
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label">Notes (optionnel)</label>
                  <textarea class="form-control" name="notes" rows="2" placeholder="Motif, pr√©cisions‚Ä¶"></textarea>
                </div>
              </div>

              <div class="d-grid d-sm-flex gap-2 mt-3">
                <button class="btn btn-primary"><i class="fas fa-calendar-check me-2"></i>R√©server</button>
                <a class="btn btn-outline-secondary" href="{{ url_for('book_appointment', professional_id=professional.id) }}">Page de r√©servation</a>
                {% if professional.phone %}
                  <a class="btn btn-outline-secondary" href="tel:{{ professional.phone|replace(' ','') }}"><i class="fas fa-phone me-2"></i>Appeler</a>
                {% endif %}
              </div>

              <div class="form-text mt-2">Vous devrez √™tre connect√©(e) pour valider la r√©servation.</div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Min date = aujourd'hui
(function(){
  const d = document.getElementById('apptDate');
  if (!d) return;
  const today = new Date();
  const pad = n => String(n).padStart(2,'0');
  const iso = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  d.min = iso;
  d.value = iso;
})();

// Fetch cr√©neaux dispo (API: /api/professional/<id>/available-slots?date=YYYY-MM-DD)
(function(){
  const dateInput = document.getElementById('apptDate');
  const grid = document.getElementById('slotGrid');
  const out = document.getElementById('apptTime');
  const proId = {{ professional.id }};

  async function loadSlots(){
    if(!dateInput || !grid) return;
    const date = dateInput.value;
    grid.innerHTML = '<span class="text-muted small">Chargement‚Ä¶</span>';
    try{
      const res = await fetch(`{{ url_for('api_available_slots', professional_id=professional.id) }}?date=${encodeURIComponent(date)}`);
      const data = await res.json();
      const slots = (data && data.available_slots) ? data.available_slots : [];

      // Filtre slots pass√©s si la date == aujourd'hui
      const now = new Date();
      const isToday = (new Date(date)).toDateString() === now.toDateString();

      grid.innerHTML = '';
      if (!slots.length){
        grid.innerHTML = '<span class="text-muted small">Aucun cr√©neau disponible pour cette date.</span>';
        out.value = '';
        return;
      }
      slots.forEach(s=>{
        let disabled = false;
        if (isToday){
          const [hh,mm] = s.start_time.split(':').map(Number);
          const slotDate = new Date(); slotDate.setHours(hh,mm,0,0);
          if (slotDate <= now) disabled = true;
        }
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm ' + (disabled ? 'btn-outline-secondary' : 'btn-outline-primary');
        btn.textContent = s.start_time;
        btn.disabled = disabled;
        btn.addEventListener('click', ()=>{
          out.value = s.start_time;
          // styling selection
          grid.querySelectorAll('button').forEach(b=>b.classList.replace('btn-primary','btn-outline-primary'));
          btn.classList.replace('btn-outline-primary','btn-primary');
        });
        grid.appendChild(btn);
      });
    }catch(e){
      console.error(e);
      grid.innerHTML = '<span class="text-danger small">Erreur lors du chargement des cr√©neaux.</span>';
    }
  }

  dateInput && dateInput.addEventListener('change', loadSlots);
  loadSlots();
})();
</script>
{% endblock %}
