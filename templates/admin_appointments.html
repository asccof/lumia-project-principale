<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tighri — Admin · Rendez-vous</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --primary:#6f42c1; --secondary:#8e44ad; --light:#f8f5ff; --ink:#2d1a47 }
    body{ background:var(--light); color:var(--ink) }
    .navbar{ background:linear-gradient(135deg,var(--primary),var(--secondary)) }
    .brand{ font-weight:800 }
    .card{ border:0; border-radius:16px; box-shadow:0 10px 24px rgba(111,66,193,.12) }
    .badge-pill{ border-radius:999px }
    .table> :not(caption)>*>*{ vertical-align:middle }
    .btn-icon{ display:inline-flex; align-items:center; gap:.45rem }
    .status-dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:.4rem }
    .status-confirme{ background:#16a34a }
    .status-attente{ background:#f59e0b }
    .status-annule{ background:#ef4444 }
    .filters .form-control, .filters .form-select{ border-radius:10px }
    .search-empty{ text-align:center; padding:3rem 1rem }
    .nowrap{ white-space:nowrap }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container">
    <a class="navbar-brand brand" href="{{ url_for('admin.admin_dashboard') }}">
      <i class="fa-solid fa-shield-halved me-2"></i>Tighri — Administration
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-light btn-sm" href="{{ url_for('change_password') }}">
        <i class="fa-solid fa-key me-1"></i>Changer mot de passe
      </a>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin.admin_logout') }}">
        <i class="fa-solid fa-right-from-bracket me-1"></i>Déconnexion
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">

  {# Messages flash #}
  {% set _cats = {'success':'success','info':'info','warning':'warning','error':'danger','danger':'danger'} %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ _cats.get(cat,'info') }} alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>{{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- En-tête & Stats -->
  <div class="row g-3 align-items-center mb-3">
    <div class="col">
      <h1 class="h4 mb-0"><i class="fa-solid fa-calendar-check text-primary me-2"></i>Rendez-vous</h1>
    </div>
    <div class="col-auto">
      <div class="d-flex gap-2">
        <span class="badge bg-secondary badge-pill">
          Total : {{ appointments|length if appointments else 0 }}
        </span>
        <span class="badge bg-success badge-pill">
          Confirmés : {{ appointments|selectattr('status','equalto','confirme')|list|length if appointments else 0 }}
        </span>
        <span class="badge bg-warning text-dark badge-pill">
          En attente : {{ appointments|selectattr('status','equalto','en_attente')|list|length if appointments else 0 }}
        </span>
        <span class="badge bg-danger badge-pill">
          Annulés : {{ appointments|selectattr('status','equalto','annule')|list|length if appointments else 0 }}
        </span>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end filters">
        <div class="col-md-4">
          <label class="form-label">Recherche</label>
          <input id="searchInput" type="text" class="form-control" placeholder="Patient, professionnel, ville…">
        </div>
        <div class="col-md-2">
          <label class="form-label">Statut</label>
          <select id="statusFilter" class="form-select">
            <option value="">Tous</option>
            <option value="confirme">Confirmé</option>
            <option value="en_attente">En attente</option>
            <option value="annule">Annulé</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Type</label>
          <select id="typeFilter" class="form-select">
            <option value="">Tous</option>
            <option value="cabinet">Cabinet</option>
            <option value="domicile">Domicile</option>
            <option value="video">Vidéo</option>
            <option value="en_ligne">En ligne</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Du</label>
          <input id="dateMin" type="date" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Au</label>
          <input id="dateMax" type="date" class="form-control">
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card">
    <div class="card-body">
      {% if appointments and appointments|length %}
        <div class="table-responsive">
          <table class="table align-middle" id="apTable">
            <thead>
              <tr>
                <th style="width:76px;">ID</th>
                <th>Patient</th>
                <th>Professionnel</th>
                <th>Date & Heure</th>
                <th>Type</th>
                <th>Statut</th>
                <th class="text-end nowrap" style="width:320px;">
                  <button id="exportCsv" class="btn btn-outline-primary btn-sm btn-icon">
                    <i class="fa-solid fa-file-export"></i> Export CSV
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for a in appointments %}
                {% set st = a.status or 'en_attente' %}
                {% set dt = a.appointment_date %}
                {% set dt_iso = (dt.isoformat() if dt else '') %}
                {% set patient_name = a.patient.username if a.patient else ('User#' ~ a.patient_id) %}
                {% set pro_name = a.professional.name if a.professional else ('Pro#' ~ a.professional_id) %}
                {% set pro_city = a.professional.location if a.professional else '' %}
                {% set typ = a.consultation_type or '' %}
                <tr
                  data-patient="{{ (patient_name or '')|lower }}"
                  data-prof="{{ (pro_name or '')|lower }}"
                  data-city="{{ (pro_city or '')|lower }}"
                  data-type="{{ typ|lower }}"
                  data-status="{{ st }}"
                  data-date="{{ dt_iso }}"
                >
                  <td class="text-muted">#{{ a.id }}</td>
                  <td>
                    <a class="text-decoration-none" href="{{ url_for('admin.edit_user', user_id=a.patient_id) }}">
                      <i class="fa-solid fa-user me-1"></i>{{ patient_name }}
                    </a>
                  </td>
                  <td>
                    <a class="text-decoration-none" href="{{ url_for('admin.view_professional', professional_id=a.professional_id) }}">
                      <i class="fa-solid fa-user-doctor me-1"></i>{{ pro_name }}
                    </a>
                    {% if pro_city %}<div class="small text-muted"><i class="fa-solid fa-location-dot me-1"></i>{{ pro_city }}</div>{% endif %}
                  </td>
                  <td class="nowrap">
                    {% if dt %}
                      {{ dt.strftime('%d/%m/%Y') }} à {{ dt.strftime('%H:%M') }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info">
                      {% if typ == 'cabinet' %}Cabinet
                      {% elif typ == 'domicile' %}Domicile
                      {% elif typ in ['video','vidéo','en_ligne'] %}Vidéo
                      {% else %}{{ typ or '—' }}{% endif %}
                    </span>
                  </td>
                  <td>
                    {% if st == 'confirme' %}
                      <span class="status-dot status-confirme"></span>
                      <span class="badge bg-success">Confirmé</span>
                    {% elif st == 'annule' %}
                      <span class="status-dot status-annule"></span>
                      <span class="badge bg-danger">Annulé</span>
                    {% else %}
                      <span class="status-dot status-attente"></span>
                      <span class="badge bg-warning text-dark">En attente</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <button class="btn btn-sm btn-success btn-icon js-set-status" data-id="{{ a.id }}" data-status="confirme"
                              {% if st == 'confirme' %}disabled{% endif %}>
                        <i class="fa-solid fa-check"></i> Confirmer
                      </button>
                      <button class="btn btn-sm btn-outline-warning btn-icon js-set-status" data-id="{{ a.id }}" data-status="en_attente"
                              {% if st == 'en_attente' %}disabled{% endif %}>
                        <i class="fa-solid fa-hourglass-half"></i> Mettre en attente
                      </button>
                      <button class="btn btn-sm btn-outline-danger btn-icon js-set-status" data-id="{{ a.id }}" data-status="annule"
                              {% if st == 'annule' %}disabled{% endif %}>
                        <i class="fa-solid fa-xmark"></i> Annuler
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="search-empty">
          <i class="fa-solid fa-calendar-xmark fa-3x text-muted mb-3"></i>
          <h2 class="h5">Aucun rendez-vous</h2>
          <p class="text-muted">Les rendez-vous s’afficheront ici dès qu’ils seront créés.</p>
          <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-primary">
            <i class="fa-solid fa-gauge me-2"></i>Retour au tableau de bord
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const $q = (sel, ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

  const searchInput = $q('#searchInput');
  const statusFilter = $q('#statusFilter');
  const typeFilter = $q('#typeFilter');
  const dateMin = $q('#dateMin');
  const dateMax = $q('#dateMax');
  const table = $q('#apTable');

  function withinDates(iso, minStr, maxStr){
    if(!iso) return true;
    const t = new Date(iso);
    if(minStr){
      const min = new Date(minStr + 'T00:00:00');
      if(t < min) return false;
    }
    if(maxStr){
      const max = new Date(maxStr + 'T23:59:59');
      if(t > max) return false;
    }
    return true;
  }

  function matchRow(tr){
    const q = (searchInput?.value || '').trim().toLowerCase();
    const st = (statusFilter?.value || '').toLowerCase();
    const tp = (typeFilter?.value || '').toLowerCase();
    const dmin = dateMin?.value || '';
    const dmax = dateMax?.value || '';

    const patient = tr.dataset.patient || '';
    const prof = tr.dataset.prof || '';
    const city = tr.dataset.city || '';
    const type = tr.dataset.type || '';
    const status = tr.dataset.status || '';
    const iso = tr.dataset.date || '';

    let ok = true;

    if(q){
      ok = (patient.includes(q) || prof.includes(q) || city.includes(q));
    }
    if(ok && st){ ok = (status === st); }
    if(ok && tp){ ok = (type === tp); }
    if(ok){ ok = withinDates(iso, dmin, dmax); }

    return ok;
  }

  function applyFilters(){
    if(!table) return;
    const rows = $$('tbody tr', table);
    rows.forEach(tr=>{
      const ok = matchRow(tr);
      tr.style.display = ok ? '' : 'none';
    });
  }

  ['input','change'].forEach(evt=>{
    [searchInput, statusFilter, typeFilter, dateMin, dateMax].forEach(el=>{
      if(el) el.addEventListener(evt, applyFilters);
    });
  });

  // CSRF pour POST JSON
  const getCSRF = () => {
    const el = document.querySelector('input[name="csrf_token"]');
    return el ? el.value : null;
  };
  async function postJSON(url, payload){
    const headers = { 'Content-Type': 'application/json' };
    const csrf = getCSRF();
    if(csrf) headers['X-CSRFToken'] = csrf;
    const res = await fetch(url, { method:'POST', headers, body: JSON.stringify(payload || {}) });
    return res.json();
  }

  // Mise à jour UI du statut
  function updateStatusUI(tr, newStatus){
    const td = tr.querySelector('td:nth-last-child(2)');
    if(td){
      td.innerHTML = (
        newStatus === 'confirme' ? '<span class="status-dot status-confirme"></span><span class="badge bg-success">Confirmé</span>' :
        newStatus === 'annule' ? '<span class="status-dot status-annule"></span><span class="badge bg-danger">Annulé</span>' :
        '<span class="status-dot status-attente"></span><span class="badge bg-warning text-dark">En attente</span>'
      );
    }
    tr.dataset.status = newStatus;

    // Désactiver/activer les bons boutons
    const btns = tr.querySelectorAll('.js-set-status');
    btns.forEach(b=>{
      const s = b.getAttribute('data-status');
      b.disabled = (s === newStatus);
    });
  }

  // Actions statut
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.js-set-status');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const newStatus = btn.getAttribute('data-status');
    const tr = btn.closest('tr');
    if(!id || !newStatus || !tr) return;

    try{
      const url = "{{ url_for('admin.update_appointment_status', appointment_id=0) }}".replace('/0/', `/${id}/`);
      const data = await postJSON(url, { status: newStatus });
      if(data && data.success){
        updateStatusUI(tr, newStatus);
      }else{
        alert(data && data.message ? data.message : 'Échec de la mise à jour');
      }
    }catch(err){
      console.error(err);
      alert('Erreur réseau');
    }
  });

  // Export CSV (visible après filtres)
  const exportBtn = document.getElementById('exportCsv');
  if(exportBtn && table){
    exportBtn.addEventListener('click', ()=>{
      const rows = Array.from(table.querySelectorAll('tbody tr')).filter(tr=> tr.style.display !== 'none');
      const headers = ['ID','Patient','Professionnel','Date','Heure','Type','Statut'];
      const lines = [headers.join(';')];
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const id   = tds[0]?.innerText.trim() || '';
        const pat  = tds[1]?.innerText.replace(/\n/g,' ').trim() || '';
        const pro  = tds[2]?.innerText.replace(/\n/g,' ').trim() || '';
        const dateHeure = tds[3]?.innerText.trim() || '';
        const [date, , heure] = dateHeure.split(' ');
        const type = tds[4]?.innerText.trim() || '';
        const stat = tds[5]?.innerText.replace(/\s+/g,' ').trim() || '';
        lines.push([id,pat,pro,date||'',heure||'',type,stat].map(v => `"${v.replace(/"/g,'""')}"`).join(';'));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rendez_vous.csv';
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    });
  }

  // Appliquer filtres au chargement
  applyFilters();
})();
</script>

{% if csrf_token is defined %}
  <!-- Injecte un token CSRF caché pour les POST JSON si CSRFProtect est actif -->
  <form style="display:none"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"></form>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
