<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ¬∑ Rendez-vous</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Tous les rendez-vous</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_dashboard') }}">‚Üê Dashboard</a>
  </div>

  {% if appointments %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Date & heure</th>
            <th>Patient</th>
            <th>Professionnel</th>
            <th>Type</th>
            <th>Statut</th>
            <th class="text-end">Mettre √† jour</th>
          </tr>
        </thead>
        <tbody>
          {% for ap in appointments %}
          <tr id="row-{{ ap.id }}">
            <td>{{ ap.id }}</td>
            <td>{{ ap.appointment_date.strftime('%d/%m/%Y %H:%M') if ap.appointment_date else '' }}</td>
            <td>
              {{ ap.patient.username }}
              {% if ap.patient.phone %}
                <div class="text-muted small">üìû {{ ap.patient.phone }}</div>
              {% endif %}
            </td>
            <td>
              {{ ap.professional.name if ap.professional else '‚Äî' }}
              {% if ap.professional and ap.professional.phone %}
                <div class="text-muted small">üìû {{ ap.professional.phone }}</div>
              {% endif %}
            </td>
            <td class="text-capitalize">{{ ap.consultation_type or 'cabinet' }}</td>
            <td>
              <span class="badge
                {% if ap.status == 'confirme' %} bg-success
                {% elif ap.status == 'annule' %} bg-secondary
                {% else %} bg-warning text-dark {% endif %}"
                id="badge-{{ ap.id }}">
                {% if ap.status == 'confirme' %}Confirm√©{% elif ap.status == 'annule' %}Annul√©{% else %}En attente{% endif %}
              </span>
            </td>
            <td class="text-end">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-success" onclick="updateStatus({{ ap.id }}, 'confirme')">Confirmer</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateStatus({{ ap.id }}, 'annule')">Annuler</button>
                <button class="btn btn-sm btn-outline-warning" onclick="updateStatus({{ ap.id }}, 'en_attente')">En attente</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">Aucun rendez-vous trouv√©.</div>
  {% endif %}
</div>

<script>
async function updateStatus(id, status){
  try{
    const res = await fetch("{{ url_for('admin.update_appointment_status', appointment_id=0) }}".replace('0', id), {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({status})
    });
    const data = await res.json();
    if(!res.ok || !data.success){ throw new Error(data.message || 'Erreur'); }

    // Mettre √† jour le badge
    const badge = document.getElementById('badge-'+id);
    if(badge){
      badge.className = 'badge';
      if(status === 'confirme'){ badge.classList.add('bg-success'); badge.textContent = 'Confirm√©'; }
      else if(status === 'annule'){ badge.classList.add('bg-secondary'); badge.textContent = 'Annul√©'; }
      else { badge.classList.add('bg-warning','text-dark'); badge.textContent = 'En attente'; }
    }
  }catch(e){
    alert('Impossible de mettre √† jour le statut : ' + e.message);
  }
}
</script>
</body>
</html>
