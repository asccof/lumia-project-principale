{% extends "admin_base.html" %}

{% block title %}Gestion des Rendez-vous — Tighri{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="fas fa-calendar-check me-2"></i>Gestion des Rendez-vous
    </h2>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary" onclick="filterAppointments('all')">
        <i class="fas fa-list me-1"></i>Tous
      </button>
      <button type="button" class="btn btn-outline-success" onclick="filterAppointments('confirme')">
        <i class="fas fa-check me-1"></i>Confirmés
      </button>
      <button type="button" class="btn btn-outline-warning" onclick="filterAppointments('en_attente')">
        <i class="fas fa-clock me-1"></i>En attente
      </button>
      <button type="button" class="btn btn-outline-danger" onclick="filterAppointments('annule')">
        <i class="fas fa-times me-1"></i>Annulés
      </button>
    </div>
  </div>

  <!-- Flashs -->
  {% set _cats = {'success':'success','info':'info','warning':'warning','error':'danger','danger':'danger'} %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ _cats.get(category, 'info') }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="appointmentsTable">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>Professionnel</th>
              <th>Date & Heure</th>
              <th>Type</th>
              <th>Statut</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments|default([]) %}
            {% set patient = appointment.patient %}
            {% set professional = appointment.professional %}
            <tr class="appointment-row" data-status="{{ appointment.status or '' }}">
              <td>{{ appointment.id }}</td>
              <td>
                <strong>{{ patient.username if patient else 'Patient inconnu' }}</strong><br>
                <small class="text-muted">{{ patient.email if patient else '' }}</small>
              </td>
              <td>
                <strong>{{ professional.name if professional else 'Professionnel inconnu' }}</strong><br>
                <small class="text-muted">{{ professional.specialty if professional else '' }}</small>
              </td>
              <td>
                {% if appointment.appointment_date %}
                  <strong>{{ appointment.appointment_date.strftime('%d/%m/%Y') }}</strong><br>
                  <small class="text-muted">{{ appointment.appointment_date.strftime('%H:%M') }}</small>
                {% else %}—{% endif %}
              </td>
              <td><span class="badge bg-info">{{ appointment.consultation_type|title }}</span></td>
              <td>
                {% if appointment.status == 'confirme' %}
                  <span class="text-success"><i class="fas fa-check-circle me-1"></i>
                    <span class="badge bg-success">Confirmé</span>
                  </span>
                {% elif appointment.status == 'en_attente' %}
                  <span class="text-warning"><i class="fas fa-clock me-1"></i>
                    <span class="badge bg-warning text-dark">En attente</span>
                  </span>
                {% else %}
                  <span class="text-danger"><i class="fas fa-times-circle me-1"></i>
                    <span class="badge bg-danger">Annulé</span>
                  </span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group" role="group">
                  {% if appointment.status == 'en_attente' %}
                    <button type="button" class="btn btn-sm btn-outline-success"
                            onclick="updateStatus({{ appointment.id }}, 'confirme')" title="Confirmer">
                      <i class="fas fa-check"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="updateStatus({{ appointment.id }}, 'annule')" title="Annuler">
                      <i class="fas fa-times"></i>
                    </button>
                  {% endif %}
                  <button type="button" class="btn btn-sm btn-outline-info"
                          onclick="viewDetails({{ appointment.id }})" title="Détails">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-1">Aucun rendez-vous trouvé</h5>
                <p class="text-muted mb-0">Aucun rendez-vous n'a été pris pour le moment.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de détails -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Détails du Rendez-vous</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
    </div>
    <div class="modal-body" id="appointmentDetails"></div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
    </div>
  </div></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // CSRF si Flask-WTF est activé
  const CSRF_TOKEN = `{{ csrf_token() if csrf_token is defined else '' }}`;
  // Endpoints générés côté serveur
  const URL_UPD_APPT_TPL = "{{ url_for('update_appointment_status', appointment_id=0) }}";
  // Si tu as une route de détail HTML (ex: view_appointment), dé-commente et utilise:
  // const URL_VIEW_APPT_TPL = "{{ url_for('view_appointment', appointment_id=0) }}";

  function headersJSON() {
    const h = { 'Content-Type': 'application/json' };
    if (CSRF_TOKEN) h['X-CSRFToken'] = CSRF_TOKEN;
    return h;
  }

  function filterAppointments(status) {
    document.querySelectorAll('.appointment-row').forEach(row => {
      row.style.display = (status === 'all' || (row.dataset.status || '') === status) ? '' : 'none';
    });
  }

  function updateStatus(appointmentId, newStatus) {
    const action = newStatus === 'confirme' ? 'confirmer' : 'annuler';
    if (!confirm(`Êtes-vous sûr de vouloir ${action} ce rendez-vous ?`)) return;

    const url = URL_UPD_APPT_TPL.replace('0', appointmentId);
    fetch(url, { method: 'POST', headers: headersJSON(), body: JSON.stringify({ status: newStatus }) })
      .then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); })
      .then(d => { if (d.success) location.reload(); else alert(d.message || 'Erreur lors de la mise à jour'); })
      .catch(err => { console.error(err); alert('Erreur lors de la mise à jour : ' + err.message); });
  }

  function viewDetails(appointmentId) {
    // Version simple inline. Si tu as une route HTML pour le détail, remplace par un fetch(URL_VIEW_APPT_TPL...)
    const el = document.getElementById('appointmentDetails');
    el.innerHTML = `
      <div class="mb-2"><strong>ID du rendez-vous :</strong> ${appointmentId}</div>
      <p class="text-muted mb-0">Brancher ici le contenu détaillé si nécessaire.</p>
    `;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
  }
</script>
{% endblock %}
