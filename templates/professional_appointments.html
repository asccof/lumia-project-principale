{# templates/professional_appointments.html #}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mes rendez-vous — Espace Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f5fa}
    .page-head{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(139,92,246,.10);padding:1rem 1.25rem;margin:1rem 0}
    .tools{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .badge-dot{display:inline-flex;align-items:center;gap:.4rem}
    .badge-dot::before{content:"";width:.5rem;height:.5rem;border-radius:50%;background:currentColor;display:inline-block}
    .row-details{background:#faf9ff}
    .filter-tabs .nav-link{border-radius:999px}
    .status-badge{font-weight:600}
    .status-en_attente{background:#fef3c7;color:#92400e}
    .status-confirme{background:#dcfce7;color:#166534}
    .status-annule{background:#e5e7eb;color:#374151}
    .table > :not(caption) > * > *{vertical-align:middle}
    .small-muted{color:#6b7280;font-size:.875rem}
  </style>
</head>
<body class="bg-light">
<div class="container py-3">

  <!-- MARKER: pro_appts v2 -->

  <div class="d-flex justify-content-between align-items-center">
    <h1 class="h4 mb-0">Mes rendez-vous</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('professional_dashboard') }}">← Tableau de bord</a>
      {% if logout is defined %}
      <a class="btn btn-outline-dark" href="{{ url_for('logout') }}">Déconnexion</a>
      {% endif %}
    </div>
  </div>

  <div class="page-head">
    <div class="tools">
      <!-- Filtres -->
      <ul class="nav nav-pills filter-tabs" id="filterTabs">
        <li class="nav-item"><button class="nav-link active" data-filter="all" type="button">Tous</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="upcoming" type="button">À venir</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="pending" type="button">En attente</button></li>
        <li class="nav-item"><button class="nav-link" data-filter="past" type="button">Passés</button></li>
      </ul>

      <!-- Tri -->
      <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
        <input id="searchBox" class="form-control" placeholder="Rechercher (nom, téléphone…)" style="width:260px">
        <select id="sortSelect" class="form-select" style="width:220px">
          <option value="desc">Trier : plus récent en haut</option>
          <option value="asc">Trier : plus ancien en haut</option>
        </select>
      </div>
    </div>
  </div>

  {% if appointments %}
    <div class="table-responsive">
      <table class="table align-middle bg-white shadow-sm rounded-3 overflow-hidden">
        <thead class="table-light">
          <tr>
            <th style="min-width:160px">Date &amp; heure</th>
            <th>Patient</th>
            <th>Type</th>
            <th>Tarif</th>
            <th>Statut</th>
            <th class="text-end" style="min-width:260px">Actions</th>
          </tr>
        </thead>
        <tbody id="apptTbody">
        {% for ap in appointments %}
          {% set p = ap.patient %}
          {% set patient_name = (p.full_name or p.username or ('Patient ' ~ p.id)) if p else 'Patient' %}
          {% set patient_phone = p.phone if p else '' %}
          {% set patient_email = p.email if p else '' %}
          {% set ts = ap.appointment_date.timestamp() if ap.appointment_date else 0 %}

          {# --- Normalisation statut (FR/EN) pour filtres et badges --- #}
          {% set _raw = (ap.status or '').lower().strip() %}
          {% if _raw in ['en_attente','en attente','en-attente','requested','pending','awaiting','new','waiting']
                 or _raw.startswith('pending') or _raw.startswith('awaiting')
                 or _raw.startswith('new') or _raw.startswith('waiting') %}
            {% set status = 'en_attente' %}
          {% elif _raw in ['confirme','confirmé','confirmed'] %}
            {% set status = 'confirme' %}
          {% elif _raw in ['annule','annulé','cancelled','canceled'] %}
            {% set status = 'annule' %}
          {% else %}
            {% set status = 'en_attente' %}
          {% endif %}
          <!-- DEBUG statut brut={{ (ap.status or '')|lower }} ⇒ mappé={{ status }} -->

          <tr
            class="appt-row"
            data-ts="{{ (ts * 1000) | int }}"
            data-status="{{ status }}"
            data-text="{{ (patient_name ~ ' ' ~ (patient_phone or '') ~ ' ' ~ (patient_email or '')) | lower }}"
          >
            <td>
              <div>{{ ap.appointment_date.strftime('%d/%m/%Y %H:%M') if ap.appointment_date else '' }}</div>
              <div class="small text-muted">
                {% if ap.appointment_date %}{{ ap.appointment_date.strftime('%A') | capitalize }}{% endif %}
              </div>
            </td>

            <td>
              <div class="fw-semibold">{{ patient_name }}</div>
              <div class="small-muted">
                {% if patient_phone %}📞 {{ patient_phone }}{% endif %}
                {% if patient_email %}{% if patient_phone %} · {% endif %}✉️ {{ patient_email }}{% endif %}
              </div>
              <button class="btn btn-link p-0 small" type="button" data-bs-toggle="collapse" data-bs-target="#det{{ ap.id }}">
                Détails
              </button>
            </td>

            <td class="text-capitalize">
              {{ ap.consultation_type or 'cabinet' }}
            </td>

            <td>
              {% set fee = ap.professional.consultation_fee if ap.professional else None %}
              {{ (fee|string) ~ ' MAD' if fee is not none else '—' }}
            </td>

            <td>
              <span class="badge status-badge status-{{ status }}">
                {% if status == 'confirme' %}Confirmé{% elif status == 'annule' %}Annulé{% else %}En attente{% endif %}
              </span>
            </td>

            <td class="text-end">
              {% set csrf = csrf_token() if csrf_token is defined else '' %}

              {% if status == 'en_attente' %}
                <form class="d-inline" method="post" action="{{ url_for('professional_appointment_action', appointment_id=ap.id, action='accept') }}">
                  {% if csrf %}<input type="hidden" name="csrf_token" value="{{ csrf }}">{% endif %}
                  <button class="btn btn-sm btn-success">Accepter</button>
                </form>

                <button
                  class="btn btn-sm btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#modalReason"
                  data-action="{{ url_for('professional_appointment_action', appointment_id=ap.id, action='reject') }}"
                  data-title="Refuser ce rendez-vous"
                  data-label="Motif (optionnel)"
                  type="button"
                >Refuser</button>

              {% elif status == 'confirme' %}
                <button
                  class="btn btn-sm btn-outline-secondary"
                  data-bs-toggle="modal"
                  data-bs-target="#modalReason"
                  data-action="{{ url_for('professional_appointment_action', appointment_id=ap.id, action='cancel') }}"
                  data-title="Annuler ce rendez-vous"
                  data-label="Motif d'annulation (optionnel)"
                  type="button"
                >Annuler</button>

              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            </td>
          </tr>

          <tr class="collapse row-details" id="det{{ ap.id }}">
            <td colspan="6" class="p-3">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="fw-semibold mb-1">Patient</div>
                  <div>{{ patient_name }}</div>
                  {% if patient_phone %}<div class="small-muted">📞 {{ patient_phone }}</div>{% endif %}
                  {% if patient_email %}<div class="small-muted">✉️ {{ patient_email }}</div>{% endif %}
                </div>
                <div class="col-md-3">
                  <div class="fw-semibold mb-1">RDV</div>
                  <div>{{ ap.appointment_date.strftime('%d/%m/%Y %H:%M') if ap.appointment_date else '' }}</div>
                  <div class="small-muted text-capitalize">{{ ap.consultation_type or 'cabinet' }}</div>
                  {% if ap.notes %}<div class="small mt-1">📝 {{ ap.notes }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                  <div class="fw-semibold mb-1">Contact rapide</div>
                  <div class="d-flex flex-wrap gap-2">
                    {% if patient_phone %}
                      <a class="btn btn-sm btn-outline-primary" href="tel:{{ patient_phone }}">Appeler</a>
                      <a class="btn btn-sm btn-outline-success" target="_blank" rel="noopener" href="https://wa.me/{{ patient_phone|replace(' ','')|replace('+','') }}">WhatsApp</a>
                    {% endif %}
                    {% if patient_email %}
                      <a class="btn btn-sm btn-outline-dark" href="mailto:{{ patient_email }}?subject=À propos de votre RDV">E-mail</a>
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info shadow-sm">Aucun rendez-vous pour le moment.</div>
  {% endif %}
</div>

<!-- Modal raison / message -->
<div class="modal fade" id="modalReason" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="reasonForm" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reasonTitle">Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <div class="mb-2">
          <label class="form-label" id="reasonLabel" for="reasonInput">Message</label>
          <textarea class="form-control" name="message" id="reasonInput" rows="3" placeholder="Votre message…"></textarea>
        </div>
        <input type="hidden" name="next" value="{{ request.full_path }}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --------- Modal dynamique (raison / message)
  const modal = document.getElementById('modalReason');
  const form  = document.getElementById('reasonForm');
  modal?.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    form.action = btn.getAttribute('data-action');
    document.getElementById('reasonTitle').textContent = btn.getAttribute('data-title') || 'Action';
    document.getElementById('reasonLabel').textContent = btn.getAttribute('data-label') || 'Message';
    document.getElementById('reasonInput').value = '';
  });

  // --------- Filtre / Tri / Recherche côté client
  const rows = Array.from(document.querySelectorAll('tr.appt-row'));
  const tbody = document.getElementById('apptTbody');
  const tabs = document.querySelectorAll('#filterTabs .nav-link');
  const sortSel = document.getElementById('sortSelect');
  const searchBox = document.getElementById('searchBox');

  function currentFilter(){
    const act = document.querySelector('#filterTabs .nav-link.active');
    return act ? act.getAttribute('data-filter') : 'all';
  }
  function isUpcoming(ts){ return ts >= Date.now(); }
  function isPast(ts){ return ts < Date.now(); }

  function matchFilter(row){
    const f = currentFilter();
    const ts = Number(row.getAttribute('data-ts') || '0');
    const st = row.getAttribute('data-status');
    if (f === 'pending') return st === 'en_attente';
    if (f === 'upcoming') return isUpcoming(ts);
    if (f === 'past') return isPast(ts);
    return true;
  }
  function matchSearch(row){
    const q = (searchBox.value || '').trim().toLowerCase();
    if (!q) return true;
    const text = row.getAttribute('data-text') || '';
    return text.includes(q);
  }
  function applyFilterSort(){
    const order = sortSel.value; // 'desc' or 'asc'

    // Filtrer visibilité
    rows.forEach(r => {
      const visible = (matchFilter(r) && matchSearch(r));
      r.style.display = visible ? '' : 'none';
      // cacher la ligne détail si la principale est cachée
      const btn = r.querySelector('button[data-bs-target]');
      const detId = btn ? btn.getAttribute('data-bs-target').replace('#','') : null;
      const det = detId ? document.getElementById(detId) : null;
      if (!visible && det) det.classList.remove('show');
    });

    // Trier les lignes visibles par timestamp
    const vis = rows.filter(r => r.style.display !== 'none');
    vis.sort((a,b) => {
      const ta = Number(a.getAttribute('data-ts')||'0');
      const tb = Number(b.getAttribute('data-ts')||'0');
      return order === 'asc' ? ta - tb : tb - ta;
    });

    // ré-attacher dans l'ordre + maintenir la ligne détail adjacente
    vis.forEach(r => {
      const btn = r.querySelector('button[data-bs-target]');
      const detId = btn ? btn.getAttribute('data-bs-target').replace('#','') : null;
      const det = detId ? document.getElementById(detId) : null;
      tbody.appendChild(r);
      if (det) tbody.appendChild(det);
    });
  }

  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    applyFilterSort();
  }));
  sortSel.addEventListener('change', applyFilterSort);
  searchBox.addEventListener('input', applyFilterSort);

  // Init
  applyFilterSort();
</script>
</body>
</html>
