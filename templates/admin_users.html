<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tighri — Admin · Utilisateurs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --primary:#6f42c1; --secondary:#8e44ad; --light:#f8f5ff; --ink:#2d1a47 }
    body{ background:var(--light); color:var(--ink) }
    .navbar{ background:linear-gradient(135deg,var(--primary),var(--secondary)) }
    .brand{ font-weight:800 }
    .card{ border:0; border-radius:16px; box-shadow:0 10px 24px rgba(111,66,193,.12) }
    .table> :not(caption)>*>*{ vertical-align:middle }
    .filters .form-control, .filters .form-select{ border-radius:10px }
    .badge-pill{ border-radius:999px }
    .btn-icon{ display:inline-flex; align-items:center; gap:.45rem }
    .search-empty{ text-align:center; padding:3rem 1rem }
    .tag-admin{ background:#111827; }
    .tag-role{ background:#e5e7eb; color:#111827 }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container">
    <a class="navbar-brand brand" href="{{ url_for('admin.admin_dashboard') }}">
      <i class="fa-solid fa-shield-halved me-2"></i>Tighri — Administration
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-light btn-sm" href="{{ url_for('change_password') }}">
        <i class="fa-solid fa-key me-1"></i>Changer mot de passe
      </a>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin.admin_logout') }}">
        <i class="fa-solid fa-right-from-bracket me-1"></i>Déconnexion
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">

  {# Messages flash #}
  {% set _cats = {'success':'success','info':'info','warning':'warning','error':'danger','danger':'danger'} %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ _cats.get(cat,'info') }} alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>{{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-2 mb-md-0"><i class="fa-solid fa-users text-primary me-2"></i>Utilisateurs</h1>
    <div class="d-flex gap-2">
      <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary btn-icon">
        <i class="fa-solid fa-user-plus"></i> Ajouter un utilisateur
      </a>
      <button id="exportCsv" class="btn btn-outline-primary btn-icon">
        <i class="fa-solid fa-file-export"></i> Export CSV
      </button>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end filters">
        <div class="col-md-5">
          <label class="form-label">Recherche</label>
          <input id="searchInput" type="text" class="form-control" placeholder="Nom d’utilisateur, email…">
        </div>
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <select id="roleFilter" class="form-select">
            <option value="">Tous</option>
            <option value="patient">Patient</option>
            <option value="professional">Professionnel</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Admin</label>
          <select id="adminFilter" class="form-select">
            <option value="">Tous</option>
            <option value="1">Oui</option>
            <option value="0">Non</option>
          </select>
        </div>
        <div class="col-md-2 text-end">
          <span class="badge bg-secondary badge-pill">
            Total : {{ users|length if users else 0 }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card">
    <div class="card-body">
      {% if users and users|length %}
        <div class="table-responsive">
          <table class="table align-middle" id="usersTable">
            <thead>
              <tr>
                <th style="width:80px;">ID</th>
                <th>Nom d’utilisateur</th>
                <th>Email</th>
                <th>Type</th>
                <th>Admin</th>
                <th class="text-end" style="width:280px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
                {% set role = (u.user_type or 'patient') %}
                {% set isadm = (u.is_admin is true) %}
                <tr
                  data-username="{{ (u.username or '')|lower }}"
                  data-email="{{ (u.email or '')|lower }}"
                  data-role="{{ role|lower }}"
                  data-admin="{{ 1 if isadm else 0 }}"
                >
                  <td class="text-muted">#{{ u.id }}</td>
                  <td class="fw-semibold">{{ u.username }}</td>
                  <td><a class="text-decoration-none" href="mailto:{{ u.email }}">{{ u.email }}</a></td>
                  <td>
                    <span class="badge tag-role">{{ role }}</span>
                  </td>
                  <td>
                    {% if isadm %}
                      <span class="badge tag-admin text-white">Administrateur</span>
                    {% else %}
                      <span class="badge bg-light text-dark">—</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <a class="btn btn-sm btn-outline-primary btn-icon"
                         href="{{ url_for('admin.edit_user', user_id=u.id) }}">
                        <i class="fa-solid fa-pen-to-square"></i> Éditer
                      </a>
                      <a class="btn btn-sm btn-outline-danger btn-icon js-del"
                         href="{{ url_for('admin.delete_user', user_id=u.id) }}">
                        <i class="fa-solid fa-trash"></i> Supprimer
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="search-empty">
          <i class="fa-solid fa-users-slash fa-3x text-muted mb-3"></i>
          <h2 class="h5">Aucun utilisateur</h2>
          <p class="text-muted">Ajoute un utilisateur pour commencer.</p>
          <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary">
            <i class="fa-solid fa-user-plus me-2"></i>Ajouter
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const $q = (sel, ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

  const searchInput = $q('#searchInput');
  const roleFilter  = $q('#roleFilter');
  const adminFilter = $q('#adminFilter');
  const table       = $q('#usersTable');

  function matchRow(tr){
    const q   = (searchInput?.value || '').trim().toLowerCase();
    const rf  = (roleFilter?.value || '').toLowerCase();
    const af  = adminFilter?.value || '';
    const u   = tr.dataset.username || '';
    const e   = tr.dataset.email || '';
    const r   = tr.dataset.role || '';
    const a   = tr.dataset.admin || '';

    let ok = true;
    if(q){ ok = (u.includes(q) || e.includes(q)); }
    if(ok && rf){ ok = (r === rf); }
    if(ok && af !== ''){ ok = (a === af); }
    return ok;
  }

  function applyFilters(){
    if(!table) return;
    const rows = $$('tbody tr', table);
    rows.forEach(tr=>{
      const ok = matchRow(tr);
      tr.style.display = ok ? '' : 'none';
    });
  }

  ['input','change'].forEach(evt=>{
    [searchInput, roleFilter, adminFilter].forEach(el=>{
      if(el) el.addEventListener(evt, applyFilters);
    });
  });

  // Confirm suppression (route GET selon admin_server.py)
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('.js-del');
    if(!a) return;
    if(!confirm('Supprimer définitivement cet utilisateur ?')) e.preventDefault();
  });

  // Export CSV (après filtres)
  const exportBtn = document.getElementById('exportCsv');
  if(exportBtn && table){
    exportBtn.addEventListener('click', ()=>{
      const visible = Array.from(table.querySelectorAll('tbody tr')).filter(tr => tr.style.display !== 'none');
      const headers = ['ID','Username','Email','Type','Admin'];
      const lines = [headers.join(';')];
      visible.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const id  = tds[0]?.innerText.trim() || '';
        const un  = tds[1]?.innerText.trim() || '';
        const em  = tds[2]?.innerText.trim() || '';
        const ty  = tds[3]?.innerText.trim() || '';
        const ad  = tds[4]?.innerText.trim() || '';
        lines.push([id,un,em,ty,ad].map(v=>`"${v.replace(/"/g,'""')}"`).join(';'));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'utilisateurs.csv';
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    });
  }

  // Appliquer filtres au chargement
  applyFilters();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
