{% extends "base.html" %}
{% block content %}
<section class="container py-4 py-md-5">

  <!-- En-tête -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-1">Facturation</h1>
      <p class="text-muted mb-0">Gérez votre abonnement, vos moyens de paiement et vos factures.</p>
    </div>
    <div class="d-none d-md-block">
      <a href="/pro-office/" class="btn btn-outline-secondary btn-pill">Retour au bureau</a>
    </div>
  </div>

  <!-- Cartes principales -->
  <div class="row g-3 g-md-4">

    <!-- Mon plan -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <h2 class="h5 mb-3">Mon plan</h2>
            {% if current_plan.status == 'actif' %}
              <span class="badge bg-success">Actif</span>
            {% else %}
              <span class="badge bg-secondary text-uppercase">{{ current_plan.status }}</span>
            {% endif %}
          </div>

          <div class="d-flex align-items-baseline gap-2 mb-2">
            <span class="h4 mb-0">{{ current_plan.name }}</span>
            {% if current_plan.price and current_plan.price > 0 %}
              <span class="text-muted">— {{ current_plan.price }} {{ current_plan.currency }} / {{ current_plan.period }}</span>
            {% else %}
              <span class="text-muted">— Gratuit</span>
            {% endif %}
          </div>

          {% if current_plan.features and current_plan.features|length %}
            <ul class="mb-3">
              {% for f in current_plan.features %}
                <li>{{ f }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if current_plan.renews_at %}
            <p class="text-muted small mb-3">Renouvellement automatique le {{ current_plan.renews_at }}</p>
          {% endif %}

          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary btn-pill">Changer d’offre</button>
            <button type="button" class="btn btn-outline-secondary btn-pill">Annuler le renouvellement</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Moyen de paiement -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Moyen de paiement</h2>

          {% if payment_method %}
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="rounded-circle border d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
                <span class="fw-bold">{{ payment_method.brand[0] if payment_method.brand else '?' }}</span>
              </div>
              <div>
                <div class="fw-semibold">{{ payment_method.brand or 'Carte' }}</div>
                <div class="text-muted small">•••• •••• •••• {{ payment_method.last4 or '••••' }} · Exp {{ payment_method.exp or '••/••' }}</div>
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-outline-secondary btn-pill">Mettre à jour</button>
              <button type="button" class="btn btn-outline-danger btn-pill">Supprimer</button>
            </div>
          {% else %}
            <p class="text-muted mb-3">Aucun moyen de paiement enregistré.</p>
            <button type="button" class="btn btn-primary btn-pill">Ajouter un moyen de paiement</button>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <!-- Factures -->
  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Factures</h2>
        <div class="d-none d-sm-block">
          <button type="button" class="btn btn-outline-secondary btn-pill">Exporter CSV</button>
        </div>
      </div>

      {% if invoices and invoices|length %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Numéro</th>
                <th>Date</th>
                <th>Montant</th>
                <th>Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
            {% for i in invoices %}
              <tr>
                <td class="fw-semibold">{{ i.id }}</td>
                <td>{{ i.date }}</td>
                <td>{{ i.amount }} {{ i.currency }}</td>
                <td>
                  {% if i.status in ['payée','paid'] %}
                    <span class="badge bg-success">Payée</span>
                  {% elif i.status in ['en_attente','pending'] %}
                    <span class="badge bg-warning text-dark">En attente</span>
                  {% else %}
                    <span class="badge bg-secondary text-uppercase">{{ i.status }}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if i.pdf_url %}
                    <a href="{{ i.pdf_url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary btn-pill">PDF</a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-4">
          <p class="text-muted mb-2">Aucune facture pour le moment.</p>
          <p class="text-muted small">Les factures payées apparaîtront ici.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Aide -->
  <div class="row g-3 g-md-4 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-2">Coordonnées de facturation</h2>
          <p class="text-muted mb-3">Ajoutez vos informations légales pour faire apparaître la raison sociale, l’adresse et l’ICE sur vos factures.</p>
          <button type="button" class="btn btn-outline-secondary btn-pill">Modifier mes coordonnées</button>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-2">Besoin d’aide ?</h2>
          <p class="text-muted mb-3">Une question sur la facturation, la TVA ou les abonnements ?</p>
          <a href="/contact" class="btn btn-outline-secondary btn-pill">Contacter le support</a>
        </div>
      </div>
    </div>
  </div>

</section>
{% endblock %}
