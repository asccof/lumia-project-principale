<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · Profil — {{ professional.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    .avatar-wrap{position:relative}
    .avatar{object-fit:cover;height:240px;cursor:zoom-in}
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;padding:.75rem}
    .thumb{width:64px;height:64px;border-radius:.5rem;overflow:hidden;background:#eee;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .thumb img{width:100%;height:100%;object-fit:cover;cursor:zoom-in;display:block}
    .badge-stack{position:absolute;top:.5rem;left:.5rem;display:flex;gap:.35rem;flex-wrap:wrap}
    .lb-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:1055}
    .lb-backdrop.is-open{display:flex}
    .lb-img{max-width:92vw;max-height:92vh;border-radius:.5rem;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .lb-close{position:absolute;top:10px;right:10px;border:none;background:#fff;border-radius:999px;padding:.35rem .6rem;cursor:pointer}
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Profil · {{ professional.name }}</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="/admin/professionals/{{ professional.id }}/availability">Disponibilités</a>
      <a class="btn btn-outline-primary" href="/admin/professionals/{{ professional.id }}/unavailable-slots">Indisponibilités</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_edit_product', product_id=professional.id) }}">Éditer</a>
      <a class="btn btn-outline-dark" href="{{ url_for('admin.admin_products') }}">← Retour</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'warning' if cat=='error' else cat }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% set tighri  = professional.certified_tighri
                   |default(professional.tighri_certified
                   |default(professional.is_certified_tighri
                   |default(false))) %}
  {% set anthecc = professional.approved_anthecc
                   |default(professional.anthecc_certified
                   |default(professional.is_certified_anthecc
                   |default(false))) %}

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="avatar-wrap">
          <img
            src="{{ url_for('profile_photo', professional_id=professional.id) }}"
            class="card-img-top avatar js-zoom"
            data-full="{{ url_for('profile_photo', professional_id=professional.id) }}"
            alt="photo"
            onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=Photo';">
          <div class="badge-stack">
            {% if tighri %}<span class="badge bg-light text-dark border border-primary">Tighri</span>{% endif %}
            {% if anthecc %}<span class="badge bg-light text-dark border border-success">ANTHECC</span>{% endif %}
          </div>
        </div>

        {% if professional.image_url2 or professional.image_url3 %}
        <div class="thumbs">
          {% if professional.image_url2 %}
          <div class="thumb"><img class="js-zoom"
            src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
            data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=2) }}"
            alt="{{ professional.name|e }} — photo 2" onerror="this.style.display='none'"></div>
          {% endif %}
          {% if professional.image_url3 %}
          <div class="thumb"><img class="js-zoom"
            src="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
            data-full="{{ url_for('profile_photo_idx', professional_id=professional.id, idx=3) }}"
            alt="{{ professional.name|e }} — photo 3" onerror="this.style.display='none'"></div>
          {% endif %}
        </div>
        {% endif %}

        <div class="card-body">
          <h5 class="card-title mb-1">{{ professional.name }}</h5>
          <div class="text-muted">{{ professional.specialty or (professional.primary_specialty.name if professional.primary_specialty else '-') }}</div>
          <div class="mt-2">
            <span class="badge bg-{{ 'success' if professional.status=='valide' else ('secondary' if professional.status=='en_attente' else 'danger') }}">{{ professional.status }}</span>
          </div>
          <hr>
          <div class="small">
            <div><strong>Ville :</strong> {{ (professional.city.name if professional.city else professional.location) or '-' }}</div>
            <div><strong>Adresse :</strong> {{ professional.address or '-' }}</div>
            <div><strong>Tél :</strong> {{ professional.phone or '-' }}</div>
            <div><strong>Lat/Lng :</strong> {{ professional.latitude or '-' }} / {{ professional.longitude or '-' }}</div>
            <div><strong>Tarif :</strong> {{ professional.consultation_fee or 0 }} MAD</div>
            <div><strong>Durée :</strong> {{ professional.consultation_duration_minutes or 45 }} min</div>
            <div><strong>Buffer :</strong> {{ professional.buffer_between_appointments_minutes or 15 }} min</div>
            <div><strong>Types :</strong> {{ professional.consultation_types or '-' }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2">Présentation</h6>
          <p class="mb-0">{{ professional.description or '—' }}</p>
        </div>
      </div>

      {% include "_pro_social_block.html" %}

      <div class="mt-3 d-flex gap-2">
        <a class="btn btn-primary" href="/admin/professionals/{{ professional.id }}/availability">Gérer les disponibilités</a>
        <a class="btn btn-outline-primary" href="/admin/professionals/{{ professional.id }}/unavailable-slots">Gérer les indisponibilités</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('admin.admin_edit_product', product_id=professional.id) }}">Modifier le profil</a>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <h2 class="h6">Derniers rendez-vous</h2>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr><th>Date/Heure</th><th>Patient</th><th>Type</th><th>Statut</th></tr>
      </thead>
      <tbody>
      {% for a in appointments %}
        <tr>
          <td>{{ a.appointment_date.strftime('%d/%m/%Y %H:%M') }}</td>
          <td>{{ a.patient.username if a.patient else a.patient_id }}</td>
          <td>{{ a.consultation_type }}</td>
          <td>
            <span class="badge bg-{{ 'success' if a.status=='confirme' else ('secondary' if a.status=='en_attente' else 'danger') }}">{{ a.status }}</span>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="4" class="text-muted">Aucun rendez-vous.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Lightbox admin -->
<div class="lb-backdrop" id="lbBackdrop" aria-modal="true" role="dialog">
  <button class="lb-close" id="lbClose" aria-label="Fermer">✕</button>
  <img id="lbImg" class="lb-img" alt="Agrandissement">
</div>
<script>
  (function(){
    const b=document.getElementById('lbBackdrop'), img=document.getElementById('lbImg'), x=document.getElementById('lbClose');
    function open(src){ img.src=src; b.classList.add('is-open'); }
    function close(){ b.classList.remove('is-open'); img.src=''; }
    document.addEventListener('click',(e)=>{ const t=e.target.closest('.js-zoom'); if(!t) return;
      e.preventDefault(); open(t.getAttribute('data-full')||t.src||'');});
    x.addEventListener('click',close); b.addEventListener('click',(e)=>{ if(e.target===b) close();});
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close();});
  })();
</script>
</body>
</html>
