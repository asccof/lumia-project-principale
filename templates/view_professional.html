{% extends "admin_base.html" %}

{% block title %}Détails du Professionnel — Tighri{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left me-1"></i>Retour
      </a>
      <h2 class="d-inline-block"><i class="fas fa-user-md me-2"></i>Détails du Professionnel</h2>
    </div>
    <div class="btn-group" role="group">
      <a href="{{ url_for('edit_professional', professional_id=professional.id) }}" class="btn btn-outline-primary">
        <i class="fas fa-edit me-1"></i>Modifier
      </a>
      <button type="button" class="btn btn-outline-danger" onclick="deleteProfessional({{ professional.id }})">
        <i class="fas fa-trash me-1"></i>Supprimer
      </button>
    </div>
  </div>

  {% set _cats = {'success':'success','info':'info','warning':'warning','error':'danger','danger':'danger'} %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flashes">
        {% for category, message in messages %}
          <div class="alert alert-{{ _cats.get(category, 'info') }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="row">
    <!-- Informations principales -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          {% set avatar = professional.image_url or professional.photo_url %}
          {% if avatar %}
            <img src="{{ avatar }}" alt="{{ professional.name or '—' }}"
                 style="width:200px;height:200px;object-fit:cover;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);" class="mb-3">
          {% else %}
            <div class="mb-3 bg-light d-flex align-items-center justify-content-center"
                 style="width:200px;height:200px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);">
              <i class="fas fa-user-md fa-4x text-muted"></i>
            </div>
          {% endif %}
          <h4 class="card-title mb-1">{{ professional.name or '—' }}</h4>
          <p class="text-muted mb-2">{{ professional.specialty or '—' }}</p>
          <div class="badge bg-primary fs-6 mb-2">{{ professional.consultation_fee or 0 }} DH</div>
        </div>
      </div>
    </div>

    <!-- Détails -->
    <div class="col-md-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations détaillées</h5>
        </div>
        <div class="card-body">
          <div class="row gy-2">
            <div class="col-md-6">
              <div class="d-flex border-bottom pb-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Nom complet :</span>
                <span>{{ professional.name or '—' }}</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Spécialité :</span>
                <span>{{ professional.specialty or '—' }}</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Localisation :</span>
                <span>{{ professional.location or '—' }}</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Téléphone :</span>
                <span>{{ professional.phone or '—' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex border-bottom pb-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Tarif :</span>
                <span>{{ professional.consultation_fee or 0 }} DH</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Expérience :</span>
                <span>{{ professional.experience_years or 0 }} ans</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Disponibilité :</span>
                <span>{{ professional.availability or '—' }}</span>
              </div>
              <div class="d-flex border-bottom pb-2 pt-2">
                <span class="fw-semibold text-primary me-2" style="min-width:160px;">Types de consultation :</span>
                <span>
                  {% if professional.consultation_types is iterable and professional.consultation_types is not string %}
                    {{ professional.consultation_types|join(', ') }}
                  {% else %}
                    {{ professional.consultation_types or '—' }}
                  {% endif %}
                </span>
              </div>
            </div>
          </div>

          <hr>
          <div>
            <div class="fw-semibold text-primary mb-2">Description :</div>
            <p class="text-muted mb-0">{{ professional.description or '—' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rendez-vous -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Rendez-vous ({{ (appointments|default([]))|length }})</h5>
        </div>
        <div class="card-body">
          {% set appts = appointments|default([]) %}
          {% if appts %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Patient</th>
                    <th>Date & Heure</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for appointment in appts %}
                  {% set patient = appointment.patient %}
                  <tr>
                    <td>{{ appointment.id }}</td>
                    <td>
                      <strong>{{ patient.username if patient else 'Patient inconnu' }}</strong><br>
                      <small class="text-muted">{{ patient.email if patient else '' }}</small>
                    </td>
                    <td>
                      {% if appointment.appointment_date %}
                        <strong>{{ appointment.appointment_date.strftime('%d/%m/%Y') }}</strong><br>
                        <small class="text-muted">{{ appointment.appointment_date.strftime('%H:%M') }}</small>
                      {% else %}—{% endif %}
                    </td>
                    <td><span class="badge bg-info">{{ appointment.consultation_type|title }}</span></td>
                    <td>
                      {% if appointment.status == 'confirme' %}
                        <span class="text-success"><i class="fas fa-check-circle me-1"></i>Confirmé</span>
                      {% elif appointment.status == 'en_attente' %}
                        <span class="text-warning"><i class="fas fa-clock me-1"></i>En attente</span>
                      {% else %}
                        <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Annulé</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        {% if appointment.status == 'en_attente' %}
                          <button type="button" class="btn btn-sm btn-outline-success"
                                  onclick="updateStatus({{ appointment.id }}, 'confirme')" title="Confirmer">
                            <i class="fas fa-check"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger"
                                  onclick="updateStatus({{ appointment.id }}, 'annule')" title="Annuler">
                            <i class="fas fa-times"></i>
                          </button>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">Aucun rendez-vous</h5>
              <p class="text-muted mb-0">Ce professionnel n'a pas encore de rendez-vous.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const CSRF_TOKEN = `{{ csrf_token() if csrf_token is defined else '' }}`;
  const URL_DELETE_PRO_TPL   = "{{ url_for('admin_delete_product', product_id=0) }}";           // supprime le pro
  const URL_UPD_APPT_TPL     = "{{ url_for('update_appointment_status', appointment_id=0) }}";  // met à jour statut RV

  function headersJSON() {
    const h = { 'Content-Type': 'application/json' };
    if (CSRF_TOKEN) h['X-CSRFToken'] = CSRF_TOKEN;
    return h;
  }

  function deleteProfessional(id) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce professionnel ?')) return;
    const url = URL_DELETE_PRO_TPL.replace('0', id);
    fetch(url, { method: 'POST', headers: headersJSON() })
      .then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); })
      .then(d => { if (d.success) window.location.href = "{{ url_for('admin_products') }}"; else alert(d.message||'Erreur lors de la suppression'); })
      .catch(err => { console.error(err); alert('Erreur lors de la suppression : ' + err.message); });
  }

  function updateStatus(appointmentId, newStatus) {
    const action = newStatus === 'confirme' ? 'confirmer' : 'annuler';
    if (!confirm(`Êtes-vous sûr de vouloir ${action} ce rendez-vous ?`)) return;
    const url = URL_UPD_APPT_TPL.replace('0', appointmentId);
    fetch(url, { method: 'POST', headers: headersJSON(), body: JSON.stringify({ status: newStatus }) })
      .then(async r => { if (!r.ok) throw new Error(await r.text()); return r.json(); })
      .then(d => { if (d.success) location.reload(); else alert(d.message||'Erreur lors de la mise à jour'); })
      .catch(err => { console.error(err); alert('Erreur lors de la mise à jour : ' + err.message); });
  }
</script>
{% endblock %}
