<!DOCTYPE html>
<html lang="{{ g.get('current_locale','fr') }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inscription professionnel — Tighri</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f5fa}
    .card{box-shadow:0 2px 12px rgba(139,92,246,.08);border-radius:14px}
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="h3 mb-3">Créer un compte professionnel</h1>

  <form id="pro-register-form" method="post" action="{{ url_for('professional_register') }}" novalidate>
    {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

    <!-- Fallbacks legacy lus par le backend -->
    <input type="hidden" name="specialty" id="specialty_hidden">
    <input type="hidden" name="city" id="city_hidden">

    <!-- Ajout-si-absent géré par app.py -->
    <input type="hidden" name="new_specialty_name" id="new_specialty_name">
    <input type="hidden" name="new_specialty_family" id="new_specialty_family">

    <div class="card p-3 p-md-4">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom d'utilisateur</label>
          <input name="username" required class="form-control" placeholder="Ex: dr_amine">
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input name="email" type="email" required class="form-control" placeholder="vous@exemple.com">
        </div>
        <div class="col-md-6">
          <label class="form-label">Mot de passe</label>
          <input name="password" type="password" required class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Téléphone</label>
          <input name="phone" required class="form-control" placeholder="06 12 34 56 78">
        </div>

        {% if (families is defined and families) and (specialties is defined and specialties) %}
          <div class="col-md-6">
            <label class="form-label">Famille (catégorie)</label>
            <select name="family" id="reg_family_name" class="form-select">
              <option value="">Toutes les familles</option>
              {% for f in families %}
                <option value="{{ f.name }}">{{ f.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Optionnel : sert à filtrer les spécialités ci-dessous.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Spécialité principale</label>
            <div class="input-group">
              <select name="primary_specialty_id" id="reg_primary_specialty_id" class="form-select">
                <option value="">Choisir dans la liste…</option>
                {% for s in specialties %}
                  <option value="{{ s.id }}" data-category="{{ s.category or '' }}">{{ s.name }}</option>
                {% endfor %}
              </select>
              <input id="spec_other" class="form-control" placeholder="Autre spécialité (si non listée)">
            </div>
            <div class="form-text">
              Si vous saisissez “Autre spécialité”, laissez le menu vide. Nous la créerons automatiquement.
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Spécialités secondaires (optionnel)</label>
            <select name="specialty_ids" id="reg_secondary_specialty_ids" class="form-select" multiple size="5">
              {% for s in specialties %}
                <option value="{{ s.id }}" data-category="{{ s.category or '' }}">{{ s.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Maintenez Ctrl (Windows) ou ⌘ (Mac) pour choisir plusieurs éléments.</div>
          </div>
        {% else %}
          <div class="col-md-6">
            <label class="form-label">Spécialité</label>
            <input name="specialty" class="form-control" placeholder="Psychologue, Thérapeute, Coach…" list="specialties_list">
            <datalist id="specialties_list">
              {% if ALL_SPECIALTIES is defined %}
                {% for s in ALL_SPECIALTIES %}
                  <option value="{{ s }}"></option>
                {% endfor %}
              {% endif %}
            </datalist>
          </div>
        {% endif %}

        {% if cities is defined and cities %}
          <div class="col-md-6">
            <label class="form-label">Ville</label>
            <div class="input-group">
              <select name="city_id" id="reg_city_id" class="form-select">
                <option value="">Choisir une ville…</option>
                {% for c in cities %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
              <input id="city_other" class="form-control" placeholder="Autre ville (si non listée)">
            </div>
            <div class="form-text">Si vous tapez une ville “Autre”, laissez le menu vide.</div>
          </div>
        {% else %}
          <div class="col-md-6">
            <label class="form-label">Ville</label>
            <input name="city" class="form-control" placeholder="Casablanca" list="cities_list">
            <datalist id="cities_list">
              {% if ALL_CITIES is defined %}
                {% for c in ALL_CITIES %}
                  <option value="{{ c }}"></option>
                {% endfor %}
              {% endif %}
            </datalist>
          </div>
        {% endif %}

        <div class="col-md-6">
          <label class="form-label">Années d’expérience</label>
          <input name="experience" type="number" min="0" class="form-control" placeholder="0">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tarif consultation (MAD)</label>
          <input name="consultation_fee" type="number" step="0.01" class="form-control" placeholder="300">
        </div>

        <div class="col-12">
          <label class="form-label">Types de consultation</label>
          <div class="d-flex flex-wrap gap-3">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="consultation_types" value="cabinet"> <span class="ms-1">Cabinet</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="consultation_types" value="visio"> <span class="ms-1">Visio</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="consultation_types" value="domicile"> <span class="ms-1">Domicile</span>
            </label>
          </div>
          <div class="form-text">Vous pourrez affiner ces options dans votre espace pro.</div>
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea name="description" rows="3" class="form-control" placeholder="Décrivez votre pratique…"></textarea>
        </div>

        <div class="col-12">
          <h6 class="mt-3">Réseaux sociaux (facultatif)</h6>
        </div>
        <div class="col-md-6">
          <label class="form-label">Facebook</label>
          <input name="facebook_url" type="url" class="form-control" placeholder="https://facebook.com/...">
        </div>
        <div class="col-md-6">
          <label class="form-label">Instagram</label>
          <input name="instagram_url" type="url" class="form-control" placeholder="https://instagram.com/...">
        </div>
        <div class="col-md-6">
          <label class="form-label">TikTok</label>
          <input name="tiktok_url" type="url" class="form-control" placeholder="https://tiktok.com/@...">
        </div>
        <div class="col-md-6">
          <label class="form-label">YouTube</label>
          <input name="youtube_url" type="url" class="form-control" placeholder="https://youtube.com/@...">
        </div>
      </div>

      <div class="d-flex align-items-center gap-3 mt-3">
        <button class="btn btn-primary">Créer mon compte</button>
        <a class="btn btn-link" href="{{ url_for('login', next=url_for('professional_dashboard')) }}">J'ai déjà un compte</a>
      </div>
    </div>
  </form>
</div>

{% if (families is defined and families) and (specialties is defined and specialties) %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const famSel   = document.getElementById('reg_family_name');
  const primary  = document.getElementById('reg_primary_specialty_id');
  const secondary= document.getElementById('reg_secondary_specialty_ids');

  function filterByFamily(){
    const cat = (famSel?.value || '').trim();
    [primary, secondary].forEach(function(sel){
      if(!sel) return;
      let firstVisible = null;
      Array.from(sel.options).forEach(function(opt){
        if(!opt.value) return;
        const ok = !cat || (String(opt.dataset.category||'') === cat);
        opt.hidden = !ok;
        if(ok && !firstVisible) firstVisible = opt;
      });
      if(sel.selectedOptions.length){
        const anyVisibleSelected = Array.from(sel.selectedOptions).some(o => !o.hidden);
        if(!anyVisibleSelected) sel.value = '';
      }
    });
  }
  famSel && famSel.addEventListener('change', filterByFamily);
  filterByFamily();
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form       = document.getElementById('pro-register-form');

  const primarySel = document.getElementById('reg_primary_specialty_id');
  const specOther  = document.getElementById('spec_other');
  const specHidden = document.getElementById('specialty_hidden');
  const famSelName = document.getElementById('reg_family_name');
  const newName    = document.getElementById('new_specialty_name');
  const newFamily  = document.getElementById('new_specialty_family');

  const citySelect = document.getElementById('reg_city_id');
  const cityOther  = document.getElementById('city_other');
  const cityHidden = document.getElementById('city_hidden');

  form && form.addEventListener('submit', function(){
    const other = (specOther?.value || '').trim();
    if (primarySel && !primarySel.value && other){
      specHidden && (specHidden.value = other);
      newName   && (newName.value    = other);
      newFamily && (newFamily.value  = (famSelName?.value || '').trim());
    } else {
      newName   && (newName.value = '');
      newFamily && (newFamily.value = '');
      specHidden&& (specHidden.value = '');
    }

    const otherCity = (cityOther?.value || '').trim();
    if (citySelect && !citySelect.value && otherCity){
      cityHidden && (cityHidden.value = otherCity);
    } else {
      cityHidden && (cityHidden.value = '');
    }
  });
});
</script>
</body>
</html>
