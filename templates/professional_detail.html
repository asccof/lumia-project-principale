

{% extends "base.html" %}
{% block title %}Profil ‚Äì {{ professional.name }}{% endblock %}

{% block extra_css %}
<style>
  :root{
    --primary:#8B5CF6; --primary-dark:#6D28D9;
    --ink:#2d1a47; --muted:#4B3869; --bg:#f7f5fa; --card:#fff;
    --shadow:0 2px 12px rgba(139,92,246,0.1); --radius:18px;
  }
  body{background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:2rem auto;padding:0 1rem}
  .top{display:grid;grid-template-columns:260px 1fr;gap:1.25rem;align-items:start}
  @media (max-width:820px){ .top{grid-template-columns:1fr} }

  .card{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:1.25rem}

  /* === Slider === */
  .slider{position:relative}
  .slide-viewport{width:220px;height:220px;border-radius:14px;overflow:hidden;background:#eee;margin:0 auto;position:relative}
  .slides{display:flex;width:100%;height:100%;transition:transform .35s ease}
  .slide{min-width:100%;height:100%}
  .slide img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .nav-btn{position:absolute;top:50%;transform:translateY(-50%);border:none;background:rgba(255,255,255,.9);box-shadow:var(--shadow);border-radius:999px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .nav-btn:disabled{opacity:.4;cursor:not-allowed}
  .nav-prev{left:-10px}
  .nav-next{right:-10px}

  .thumbs{display:flex;gap:.4rem;justify-content:center;margin:.6rem 0 0}
  .thumb{width:64px;height:64px;border-radius:10px;overflow:hidden;background:#eee;opacity:.7;border:2px solid transparent}
  .thumb.is-active{opacity:1;border-color:#8B5CF6}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;cursor:pointer}

  .name{margin:.25rem 0 .35rem;color:#6D28D9}
  .meta{color:#4B3869;opacity:.95}
  .badges{display:flex;flex-wrap:wrap;gap:.45rem;margin:.5rem 0 0}
  .b{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .55rem;border-radius:999px;font-size:.78rem;font-weight:700;background:#fff;border:1.5px solid #e8e0ff}
  .b svg{width:16px;height:16px}
  .b-tighri{border-color:#8B5CF6}
  .b-anthecc{border-color:#10b981}

  .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:1rem}
  .btn{display:inline-block;background:var(--primary);color:#fff;text-decoration:none;border:none;border-radius:999px;padding:.7rem 1.2rem;font-weight:700}
  .btn:hover{background:var(--primary-dark)}
  .btn-alt{background:#fff;color:#6D28D9;border:2px solid #e6dcff}

  .section{margin-top:1rem}
  .section h2{margin:.2rem 0 .6rem;color:#6D28D9;font-size:1.2rem}
  .box{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:1rem}
  .list{display:flex;flex-wrap:wrap;gap:.5rem}
  .pill{background:#f4f0ff;border:1px solid #e6dcff;border-radius:999px;padding:.25rem .6rem;font-size:.85rem}

  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  @media (max-width:700px){ .gallery{grid-template-columns:1fr 1fr} }
  .gimg{aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#eee;width:100%;cursor:zoom-in}

  /* Lightbox */
  .lightbox-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
  .lightbox-backdrop.is-open{display:flex}
  .lightbox-img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .lightbox-close{position:absolute;top:10px;right:10px;border:none;background:#fff;border-radius:999px;padding:.4rem .6rem;cursor:pointer}
</style>
{% endblock %}

{% block content %}
{% set loc = professional.city.name if professional.city else professional.location %}
{% set main_spec = professional.specialty or (professional.primary_specialty.name if professional.primary_specialty else "") %}
{% set main_cat  = professional.primary_specialty.category if professional.primary_specialty else "" %}
{% set show_social = professional.social_links_approved|default(false) %}

{% set url1 = professional_photo_url(professional, 1) %}
{% set url2 = professional_photo_url(professional, 2) %}
{% set url3 = professional_photo_url(professional, 3) %}
{% set imgs = [] %}
{% if url1 %}{% set _ = imgs.append(url1) %}{% endif %}
{% if url2 %}{% set _ = imgs.append(url2) %}{% endif %}
{% if url3 %}{% set _ = imgs.append(url3) %}{% endif %}


<div class="wrap">
  <div class="top">
    <aside class="card">
      <!-- Slider -->
      <div class="slider" id="proSlider" aria-label="Photos du professionnel">
        <button class="nav-btn nav-prev" id="sPrev" aria-label="Pr√©c√©dent">‚Äπ</button>
        <div class="slide-viewport" id="sViewport">
          <div class="slides" id="sTrack" style="transform:translateX(0)">
            {% for u in imgs %}
            <div class="slide">
              <img class="js-zoom" src="{{ u }}" data-full="{{ u }}" alt="Photo {{ loop.index }} ‚Äî {{ professional.name|e }}"
                   onerror="this.onerror=null;this.src='https://placehold.co/500x500?text=Photo';">
            </div>
            {% endfor %}
          </div>
        </div>
        <button class="nav-btn nav-next" id="sNext" aria-label="Suivant">‚Ä∫</button>

        {% if imgs|length > 1 %}
        <div class="thumbs" id="sThumbs">
          {% for u in imgs %}
          <div class="thumb{% if loop.index0 == 0 %} is-active{% endif %}" data-idx="{{ loop.index0 }}">
            <img src="{{ u }}" alt="Miniature {{ loop.index }}" onerror="this.style.display='none'">
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </aside>

    <section class="card">
      {% set tighri  = professional.certified_tighri
                       |default(professional.tighri_certified
                       |default(professional.is_certified_tighri
                       |default(false))) %}
      {% set anthecc = professional.approved_anthecc
                       |default(professional.anthecc_certified
                       |default(professional.is_certified_anthecc
                       |default(false))) %}

      <h1 class="name">{{ professional.name }}</h1>
      <div class="meta">
        {{ main_spec or 'Professionnel' }}
        {% if main_cat %} ¬∑ {{ main_cat }}{% endif %}
        {% if loc %} ¬∑ {{ loc }}{% endif %}
        {% if professional.experience_years %} ¬∑ {{ professional.experience_years }} ans d'exp√©rience{% endif %}
        {% if professional.consultation_fee %} ¬∑ {{ professional.consultation_fee|int if professional.consultation_fee==professional.consultation_fee|int else professional.consultation_fee }} MAD{% endif %}
      </div>

      <div class="badges">
        {% if tighri %}
          <span class="b b-tighri" title="Certifi√© Tighri">
            <svg viewBox="0 0 24 24" fill="none"><path d="M20 7l-9 9-5-5" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Certifi√© Tighri
          </span>
        {% endif %}
        {% if anthecc %}
          <span class="b b-anthecc" title="Certifi√© ANTHECC">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 6 .9-4.5 4.3 1.1 6.5L12 17l-5.6 3.7 1.1-6.5L3 9.9 9 9z" stroke="#10b981" stroke-width="1.6" stroke-linejoin="round"/></svg>
            Certifi√© ANTHECC
          </span>
        {% endif %}
      </div>

      <div class="actions">
        <a class="btn btn-primary" href="{{ url_for('patient_book', professional_id=professional.id) }}">
          R√©server un rendez-vous
        </a>
        {% if professional.phone %}
          <a class="btn btn-alt" href="tel:{{ professional.phone|replace(' ','')|replace('.','') }}">Appeler</a>
        {% endif %}
      </div>
    </section>
  </div>

  <div class="section">
    <h2>Pr√©sentation</h2>
    <div class="box">
      {% set d = professional.description or 'Profil en cours de compl√©tion.' %}
      <p style="margin:.2rem 0 0;color:#4B3869;line-height:1.75">{{ d }}</p>
    </div>
  </div>

  <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
    <div class="box">
      <h2>Informations</h2>
      <div class="list" style="color:#4B3869">
        {% if professional.address %}<div class="pill">üìç {{ professional.address }}</div>{% endif %}
        {% if loc %}<div class="pill">üèôÔ∏è {{ loc }}</div>{% endif %}
        {% if professional.consultation_types %}
          {% for ct in professional.consultation_types.split(',') %}
            {% if ct %}<div class="pill">{{ 'En ligne' if ct=='en_ligne' else ct|capitalize }}</div>{% endif %}
          {% endfor %}
        {% endif %}
        {% if professional.consultation_duration_minutes %}<div class="pill">‚è± {{ professional.consultation_duration_minutes }} min</div>{% endif %}
        {% if professional.buffer_between_appointments_minutes %}<div class="pill">‚ûï Pause {{ professional.buffer_between_appointments_minutes }} min</div>{% endif %}
      </div>
    </div>

    <div class="box">
      <h2>Sp√©cialit√©s</h2>
      <div class="list">
        {% if main_spec %}<div class="pill">{{ main_spec }}</div>{% endif %}
        {% if professional.specialties %}
          {% for s in professional.specialties %}
            {% if not main_spec or s.name != main_spec %}
              <div class="pill">{{ s.name }}</div>
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if not main_spec and not (professional.specialties and professional.specialties|length) %}
          <span style="color:#6b5a82">‚Äî</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if imgs|length > 1 %}
  <div class="section">
    <h2>Galerie</h2>
    <div class="box">
      <div class="gallery">
        {% for u in imgs[1:] %}
          <img class="gimg js-zoom" src="{{ u }}" data-full="{{ u }}" alt="Photo ‚Äî {{ professional.name|e }}"
               loading="lazy" onerror="this.style.display='none'">
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="section">
    <h2>R√©server</h2>
    <div class="box" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap">
      <div style="color:#4B3869">Choisissez une date sur la page de r√©servation pour voir les cr√©neaux disponibles.</div>
      <a class="btn btn-outline-primary" href="{{ url_for('patient_booking', professional_id=professional.id, mode='all') }}">
        Aller √† la r√©servation
      </a>
    </div>
  </div>

  <div class="section">
    {% set maps_q = None %}
    {% if professional.latitude is not none and professional.longitude is not none %}
      {% set maps_q = (professional.latitude|string) ~ ',' ~ (professional.longitude|string) %}
    {% elif professional.address %}
      {% set maps_q = professional.address %}
    {% elif loc %}
      {% set maps_q = loc %}
    {% endif %}
    {% if maps_q %}
      <a class="btn btn-alt" target="_blank" rel="noopener"
         href="https://www.google.com/maps?q={{ maps_q|replace(' ','+') }}">Voir sur Google Maps</a>
    {% endif %}
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox-backdrop" id="lbBackdrop" aria-modal="true" role="dialog">
  <button class="lightbox-close" id="lbClose" aria-label="{{ t('lightbox.close','Fermer') }}">‚úï</button>
  <img id="lbImg" class="lightbox-img" alt="{{ t('lightbox.zoom_alt','Agrandissement') }}">
</div>
<script>
  (function(){
    // Lightbox (inchang√©)
    const b=document.getElementById('lbBackdrop'), img=document.getElementById('lbImg'), x=document.getElementById('lbClose');
    function open(src){ img.src=src; b.classList.add('is-open'); }
    function close(){ b.classList.remove('is-open'); img.src=''; }
    document.addEventListener('click',(e)=>{ const t=e.target.closest('.js-zoom'); if(!t) return;
      e.preventDefault(); open(t.getAttribute('data-full')||t.src||'');});
    x.addEventListener('click',close); b.addEventListener('click',(e)=>{ if(e.target===b) close();});
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close();});
  })();
</script>
<script>
  // Slider minimal sans d√©pendance
  (function(){
    const track = document.getElementById('sTrack');
    if(!track) return;
    const slides = Array.from(track.children);
    const prev = document.getElementById('sPrev');
    const next = document.getElementById('sNext');
    const thumbsWrap = document.getElementById('sThumbs');
    const thumbs = thumbsWrap ? Array.from(thumbsWrap.querySelectorAll('.thumb')) : [];
    const viewport = document.getElementById('sViewport');

    let idx = 0, n = slides.length;

    function update(){
      track.style.transform = 'translateX(' + (-idx*100) + '%)';
      if(prev) prev.disabled = (idx===0);
      if(next) next.disabled = (idx===n-1);
      thumbs.forEach((t,i)=>t.classList.toggle('is-active', i===idx));
    }
    function go(i){
      idx = Math.max(0, Math.min(n-1, i)); update();
    }

    // Buttons
    prev && prev.addEventListener('click', ()=>go(idx-1));
    next && next.addEventListener('click', ()=>go(idx+1));

    // Dots / thumbs
    thumbs.forEach(t => t.addEventListener('click', ()=>go(parseInt(t.dataset.idx||'0',10)||0)));

    // Keyboard
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft') go(idx-1);
      if(e.key==='ArrowRight') go(idx+1);
    });

    // Touch swipe
    let sx=0, dx=0, touching=false;
    function onStart(e){ touching=true; sx=(e.touches?e.touches[0].clientX:e.clientX); }
    function onMove(e){ if(!touching) return; dx=((e.touches?e.touches[0].clientX:e.clientX)-sx); }
    function onEnd(){ if(!touching) return; if(dx<-40) go(idx+1); else if(dx>40) go(idx-1); touching=false; sx=0; dx=0; }
    (viewport||track).addEventListener('touchstart', onStart, {passive:true});
    (viewport||track).addEventListener('touchmove', onMove, {passive:true});
    (viewport||track).addEventListener('touchend', onEnd);

    update();
  })();
</script>
{% endblock %}
