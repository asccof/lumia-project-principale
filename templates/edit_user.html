{% extends "admin_base.html" %}
{% block title %}Modifier un utilisateur - Admin Tighri{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row"><div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">
          <i class="fas fa-user-edit me-2"></i>Modifier l'utilisateur
        </h4>
        <!-- Conversion rapide vers “Professionnel” -->
        <button type="button" class="btn btn-outline-success btn-sm" id="convertToProBtn">
          <i class="fas fa-user-tie me-1"></i> Convertir en professionnel
        </button>
      </div>

      <div class="card-body">
        <form method="POST" action="{{ url_for('admin.edit_user', user_id=user.id) }}" accept-charset="utf-8" id="editUserForm">
          {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="username" class="form-label">Nom d'utilisateur *</label>
                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="email" class="form-label">Email *</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user_type" class="form-label">Type d'utilisateur</label>
                <select id="user_type" name="user_type" class="form-select">
                  <option value="patient" {{ 'selected' if user.user_type=='patient' else '' }}>Patient</option>
                  <option value="professional" {{ 'selected' if user.user_type=='professional' else '' }}>Professionnel</option>
                </select>
                <div class="form-text">
                  Si vous choisissez <strong>Professionnel</strong>, un profil pro sera
                  <em>créé automatiquement</em> (ou mis à jour) si nécessaire.
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label for="password" class="form-label">Nouveau mot de passe (laisser vide)</label>
                <input type="password" class="form-control" id="password" name="password" autocomplete="new-password">
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Téléphone -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="phone" class="form-label">Téléphone</label>
                <input type="text" class="form-control" id="phone" name="phone" value="{{ user.phone or '' }}" placeholder="+212 6 12 34 56 78">
              </div>
            </div>

            <div class="col-md-6 d-flex align-items-center">
              <div class="form-check mb-3 mt-2">
                <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                <label class="form-check-label" for="is_admin">Administrateur</label>
              </div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-6">
              <p class="text-muted mb-0">
                <strong>Date de création:</strong>
                {% if user.created_at %}{{ user.created_at.strftime('%d/%m/%Y à %H:%M') }}{% else %}-{% endif %}
              </p>
            </div>
          </div>

          <!-- ========= PROFIL PROFESSIONNEL ========= -->
          <div id="proSection" class="mt-4" style="display:none;">
            <hr class="my-4">
            <h5 class="mb-3"><i class="fas fa-user-tie me-2"></i>Profil professionnel</h5>

            {% set P = pro if pro is defined else None %}

            <!-- ======= Taxonomie (Famille + Spécialités) ======= -->
            <div class="row">
              {% if (families is defined and families) and (specialties is defined and specialties) %}
                <!-- Famille = filtre visuel; la valeur n'est pas obligatoire -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Famille (catégorie)</label>
                    <select id="pro_family" class="form-select">
                      <option value="">Toutes les familles</option>
                      {% for f in families %}
                        <option value="{{ f.name }}">{{ f.name }}</option>
                      {% endfor %}
                    </select>
                    <div class="form-text">Filtre la liste des spécialités.</div>
                  </div>
                </div>

                <!-- Spécialité principale (ID) + “Autre” -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Spécialité principale</label>
                    <div class="input-group">
                      <select name="primary_specialty_id" id="pro_primary_specialty_id" class="form-select">
                        <option value="">Choisir dans la liste…</option>
                        {% for s in specialties %}
                          <option value="{{ s.id }}" data-category="{{ s.category or '' }}"
                                  {% if P and P.primary_specialty and P.primary_specialty.id==s.id %}selected{% endif %}>
                            {{ s.name }}
                          </option>
                        {% endfor %}
                      </select>
                      <input id="pro_spec_other" class="form-control" placeholder="Autre spécialité (si non listée)">
                    </div>
                    <div class="form-text">Si vous saisissez “Autre”, laissez le menu vide.</div>
                  </div>
                </div>

                <!-- Spécialités secondaires (multi) -->
                <div class="col-12">
                  <div class="mb-3">
                    <label class="form-label">Spécialités secondaires (optionnel)</label>
                    <select name="specialty_ids" id="pro_secondary_specialty_ids" class="form-select" multiple size="6">
                      {% set sec_ids = (P.specialties|map(attribute='id')|list if P and P.specialties else []) %}
                      {% for s in specialties %}
                        <option value="{{ s.id }}" data-category="{{ s.category or '' }}"
                          {% if s.id in sec_ids %}selected{% endif %}>{{ s.name }}</option>
                      {% endfor %}
                    </select>
                    <div class="form-text">Maintenez Ctrl (Windows) ou ⌘ (Mac) pour multi-sélectionner.</div>
                  </div>
                </div>

                <!-- Champs “création si absente” + compat legacy -->
                <input type="hidden" name="new_specialty_name" id="new_specialty_name">
                <input type="hidden" name="new_specialty_family" id="new_specialty_family">
                <input type="hidden" name="pro_specialty" id="pro_specialty_legacy" value="{{ (P.specialty if P else '') or '' }}">
              {% else %}
                <!-- Fallback simple texte (aucune liste fournie) -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Spécialité</label>
                    <input type="text" class="form-control" name="pro_specialty" value="{{ (P.specialty if P else '') or '' }}"
                           placeholder="Psychologue, Coach…" list="specialties_list">
                    <datalist id="specialties_list">
                      {% if ALL_SPECIALTIES is defined %}
                        {% for s in ALL_SPECIALTIES %}
                          <option value="{{ s }}"></option>
                        {% endfor %}
                      {% endif %}
                    </datalist>
                  </div>
                </div>
              {% endif %}
            </div>

            <!-- ======= Infos générales ======= -->
            <div class="row">
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Années d'expérience</label>
                  <input type="number" class="form-control" name="pro_experience_years" value="{{ (P.experience_years if P else '') or '' }}" min="0" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Tarif (MAD)</label>
                  <input type="text" class="form-control" name="pro_consultation_fee" value="{{ (P.consultation_fee if P else '') or '' }}" placeholder="350">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Ville</label>
                  <!-- CONTRAT FIXE : backend lit name="pro_location" (texte) -->
                  <input type="text" class="form-control" name="pro_location"
                         value="{{ (P.location if P else '') or '' }}"
                         placeholder="Casablanca" list="morocco_cities">
                  <datalist id="morocco_cities">
                    {% if ALL_CITIES is defined %}
                      {% for c in ALL_CITIES %}
                        <option value="{{ c }}"></option>
                      {% endfor %}
                    {% else %}
                      <option value="Casablanca"><option value="Rabat"><option value="Fès"><option value="Marrakech"><option value="Tanger"><option value="Agadir">
                    {% endif %}
                  </datalist>
                  <div class="form-text">Saisie assistée sur une liste très élargie des villes marocaines.</div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="pro_description" rows="3" placeholder="Présentation...">{{ (P.description if P else '') or '' }}</textarea>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label class="form-label">Adresse</label>
                  <input type="text" class="form-control" name="pro_address" value="{{ (P.address if P else '') or '' }}" placeholder="Adresse complète (optionnel)">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Latitude</label>
                  <input type="text" class="form-control" name="pro_latitude" value="{{ (P.latitude if P else '') or '' }}" placeholder="33.5731">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Longitude</label>
                  <input type="text" class="form-control" name="pro_longitude" value="{{ (P.longitude if P else '') or '' }}" placeholder="-7.5898">
                </div>
              </div>
            </div>

            <!-- Statuts / types -->
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Statut</label>
                  {% set st = (P.status if P else '') or '' %}
                  <select class="form-select" name="pro_status">
                    <option value="" {{ 'selected' if st=='' else '' }}>— Ne pas changer —</option>
                    <option value="en_attente" {{ 'selected' if st=='en_attente' else '' }}>En attente</option>
                    <option value="valide" {{ 'selected' if st=='valide' else '' }}>Validé</option>
                    <option value="rejete" {{ 'selected' if st=='rejete' else '' }}>Rejeté</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Disponibilité</label>
                  {% set av = (P.availability if P else '') or '' %}
                  <select class="form-select" name="pro_availability">
                    <option value="" {{ 'selected' if av=='' else '' }}>— Ne pas changer —</option>
                    <option value="disponible" {{ 'selected' if av=='disponible' else '' }}>Disponible</option>
                    <option value="indisponible" {{ 'selected' if av=='indisponible' else '' }}>Indisponible</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Types de consultation</label>
                  {% set t = (P.consultation_types if P else '') or '' %}
                  {% set has_cab = 'cabinet' in t %}
                  {% set has_dom = 'domicile' in t %}
                  {% set has_online = ('en_ligne' in t) or ('visio' in t) %}
                  <div class="form-check"><input class="form-check-input pro-type" type="checkbox" id="t_cab" value="cabinet" {% if has_cab %}checked{% endif %}><label class="form-check-label" for="t_cab">Cabinet</label></div>
                  <div class="form-check"><input class="form-check-input pro-type" type="checkbox" id="t_dom" value="domicile" {% if has_dom %}checked{% endif %}><label class="form-check-label" for="t_dom">Domicile</label></div>
                  <div class="form-check"><input class="form-check-input pro-type" type="checkbox" id="t_onl" value="en_ligne" {% if has_online %}checked{% endif %}><label class="form-check-label" for="t_onl">En ligne</label></div>
                  <input type="hidden" name="pro_consultation_types" id="pro_consultation_types" value="{{ t }}">
                  <div class="form-text">Laisser vide pour ne pas modifier.</div>
                </div>
              </div>
            </div>

            <!-- Paramètres RDV / mise en avant -->
            <div class="row">
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Durée (minutes)</label>
                  <input type="number" class="form-control" name="pro_duration_minutes" value="{{ (P.consultation_duration_minutes if P else '') or '' }}" min="5" max="240">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Buffer (minutes)</label>
                  <input type="number" class="form-control" name="pro_buffer_minutes" value="{{ (P.buffer_between_appointments_minutes if P else '') or '' }}" min="0" max="120">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Mise en avant</label>
                  {% set feat = (P.is_featured if P else None) %}
                  <select class="form-select" name="pro_is_featured">
                    <option value="" {{ 'selected' if feat is none else '' }}>— Ne pas changer —</option>
                    <option value="on" {{ 'selected' if feat==True else '' }}>Oui</option>
                    <option value="off" {{ 'selected' if feat==False else '' }}>Non</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Rang (mise en avant)</label>
                  <input type="number" class="form-control" name="pro_featured_rank" value="{{ (P.featured_rank if P else '') or '' }}" min="1" step="1" placeholder="1 = top">
                </div>
              </div>
            </div>

            <!-- Réseaux sociaux -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Facebook</label>
                  <input type="url" class="form-control" name="pro_facebook_url" value="{{ (P.facebook_url if P else '') or '' }}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Instagram</label>
                  <input type="url" class="form-control" name="pro_instagram_url" value="{{ (P.instagram_url if P else '') or '' }}">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">TikTok</label>
                  <input type="url" class="form-control" name="pro_tiktok_url" value="{{ (P.tiktok_url if P else '') or '' }}">
                </div>
                <div class="mb-3">
                  <label class="form-label">YouTube</label>
                  <input type="url" class="form-control" name="pro_youtube_url" value="{{ (P.youtube_url if P else '') or '' }}">
                </div>
              </div>
            </div>

            <!-- Images -->
            <div class="mb-3">
              <label class="form-label">Image (URL) principale</label>
              <input type="url" class="form-control" name="pro_image_url" value="{{ (P.image_url if P else '') or '' }}" placeholder="/media/profiles/xxxx.jpg ou https://...">
              <div class="form-text">Pour téléverser un fichier image, utilisez l’écran d’édition du professionnel.</div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Image (URL) #2</label>
                  <input type="url" class="form-control" name="pro_image_url2" value="{{ (P.image_url2 if P else '') or '' }}" placeholder="https://... (optionnel)">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Image (URL) #3</label>
                  <input type="url" class="form-control" name="pro_image_url3" value="{{ (P.image_url3 if P else '') or '' }}" placeholder="https://... (optionnel)">
                </div>
              </div>
            </div>
          </div>
          <!-- ========= /PROFIL PROFESSIONNEL ========= -->

          <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('admin.admin_users') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div></div>
</div>

<!-- JS : familles → filtre spécialités ; sérialisation types ; “Autre” spécialité ; toggle section pro -->
<script>
(function () {
  const form = document.getElementById('editUserForm');
  const btnConvert = document.getElementById('convertToProBtn');
  const userType = document.getElementById('user_type');
  const proSection = document.getElementById('proSection');

  const famSel   = document.getElementById('pro_family');
  const primSel  = document.getElementById('pro_primary_specialty_id');
  const secSel   = document.getElementById('pro_secondary_specialty_ids');
  const specOther= document.getElementById('pro_spec_other');
  const newName  = document.getElementById('new_specialty_name');
  const newFam   = document.getElementById('new_specialty_family');
  const specLegacy = document.getElementById('pro_specialty_legacy');

  function toggleProSection() {
    if (!proSection) return;
    proSection.style.display = (userType && userType.value === 'professional') ? '' : 'none';
  }

  function filterByFamily() {
    if (!famSel) return;
    const cat = (famSel.value || '').trim();
    [primSel, secSel].forEach(function(sel){
      if(!sel) return;
      let firstVisible = null;
      Array.from(sel.options).forEach(function(opt){
        if(!opt.value) return;
        const ok = !cat || (String(opt.dataset.category||'') === cat);
        opt.hidden = !ok;
        if(ok && !firstVisible) firstVisible = opt;
      });
      // si la sélection active n'est plus visible, reset
      if(sel.selectedOptions.length){
        const anyVisible = Array.from(sel.selectedOptions).some(o => !o.hidden);
        if(!anyVisible) sel.value = '';
      }
    });
  }

  function serializeTypes() {
    const checks = document.querySelectorAll('.pro-type');
    const hidden = document.getElementById('pro_consultation_types');
    if (!checks || !hidden) return;
    const vals = [];
    checks.forEach(ch => { if (ch.checked) vals.push(ch.value); });
    if (vals.length > 0) hidden.value = vals.join(','); // sinon laisser vide (“ne pas changer”)
  }

  // “Autre spécialité” → legacy + création si absente
  function handleOtherSpecialty() {
    const other = (specOther ? specOther.value.trim() : '');
    if (primSel && !primSel.value && other) {
      if (specLegacy) specLegacy.value = other;        // compat backend legacy
      if (newName)   newName.value = other;            // création
      if (newFam)    newFam.value  = (famSel ? (famSel.value||'').trim() : '');
    } else {
      if (newName)   newName.value = '';
      if (newFam)    newFam.value  = '';
      // ne pas écraser la valeur legacy existante si Admin l’avait saisie à la main
    }
  }

  // Init / events
  if (btnConvert && userType) {
    btnConvert.addEventListener('click', function () {
      try {
        userType.value = 'professional';
        serializeTypes();
        handleOtherSpecialty();
        form.submit();
      } catch (e) { console.error(e); }
    });
  }

  if (form) {
    form.addEventListener('submit', function(){
      serializeTypes();
      handleOtherSpecialty();
    });
  }

  if (userType) {
    userType.addEventListener('change', toggleProSection);
    toggleProSection();
  }

  if (famSel) {
    famSel.addEventListener('change', filterByFamily);
    filterByFamily();
  }
})();
</script>
{% endblock %}
