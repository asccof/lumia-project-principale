{% extends "admin_base.html" %}
{% block title %}Modifier un utilisateur - Admin Lumia{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row"><div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">
          <i class="fas fa-user-edit me-2"></i>Modifier l'utilisateur
        </h4>
        <!-- Bouton conversion rapide vers "Professionnel" (soumet le formulaire) -->
        <button type="button" class="btn btn-outline-success btn-sm" id="convertToProBtn">
          <i class="fas fa-user-tie me-1"></i> Convertir en professionnel
        </button>
      </div>

      <div class="card-body">
        <form method="POST" action="{{ url_for('admin.edit_user', user_id=user.id) }}" accept-charset="utf-8" id="editUserForm">
          {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="username" class="form-label">Nom d'utilisateur *</label>
                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="email" class="form-label">Email *</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="user_type" class="form-label">Type d'utilisateur</label>
                <select id="user_type" name="user_type" class="form-select">
                  <option value="patient" {{ 'selected' if user.user_type=='patient' else '' }}>Patient</option>
                  <option value="professional" {{ 'selected' if user.user_type=='professional' else '' }}>Professionnel</option>
                </select>
                <div class="form-text">
                  Si vous choisissez <strong>Professionnel</strong>, un profil pro sera
                  <em>créé automatiquement</em> (ou mis à jour) si nécessaire.
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label for="password" class="form-label">Nouveau mot de passe (laisser vide)</label>
                <!-- Le backend accepte "new_password" OU "password". On garde "password" pour compatibilité. -->
                <input type="password" class="form-control" id="password" name="password" autocomplete="new-password">
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Téléphone (utilisé par admin_server.edit_user) -->
            <div class="col-md-6">
              <div class="mb-3">
                <label for="phone" class="form-label">Téléphone</label>
                <input type="text" class="form-control" id="phone" name="phone" value="{{ user.phone or '' }}" placeholder="+212 6 12 34 56 78">
              </div>
            </div>

            <div class="col-md-6 d-flex align-items-center">
              <div class="form-check mb-3 mt-2">
                <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                <label class="form-check-label" for="is_admin">Administrateur</label>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <p class="text-muted mb-0">
                <strong>Date de création:</strong>
                {% if user.created_at %}{{ user.created_at.strftime('%d/%m/%Y à %H:%M') }}{% else %}-{% endif %}
              </p>
            </div>
          </div>

          <!-- ========= Bloc PROFIL PROFESSIONNEL (affiché si user_type=professional) ========= -->
          <div id="proSection" class="mt-4" style="display:none;">
            <hr class="my-4">
            <h5 class="mb-3"><i class="fas fa-user-tie me-2"></i>Profil professionnel</h5>

            <!-- Aide : si la fiche pro existe, on remplit les valeurs ; sinon vide -->
            {% set P = pro if pro is defined else None %}

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Spécialité</label>
                  <input type="text" class="form-control" name="pro_specialty" value="{{ (P.specialty if P else '') or '' }}" placeholder="Psychologue, Coach, etc.">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Années d'expérience</label>
                  <input type="number" class="form-control" name="pro_experience_years" value="{{ (P.experience_years if P else '') or '' }}" min="0" step="1">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Tarif (MAD)</label>
                  <input type="text" class="form-control" name="pro_consultation_fee" value="{{ (P.consultation_fee if P else '') or '' }}" placeholder="350">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="pro_description" rows="3" placeholder="Présentation...">{{ (P.description if P else '') or '' }}</textarea>
            </div>

            <div class="row">
            <div class="col-md-4">
  <div class="mb-3">
    <label class="form-label">Ville</label>
    <!-- CONTRAT FIXE : on garde name="pro_location" -->
    <input
      type="text"
      class="form-control"
      name="pro_location"
      value="{{ (P.location if P else '') or '' }}"
      placeholder="Casablanca"
      list="morocco_cities"
    >
    <!-- Liste de villes marocaines (datalist = autocomplétion sans changer le backend) -->
    <datalist id="morocco_cities">
      <option value="Casablanca">
      <option value="Rabat">
      <option value="Fès">
      <option value="Marrakech">
      <option value="Tanger">
      <option value="Agadir">
      <option value="Meknès">
      <option value="Oujda">
      <option value="Kénitra">
      <option value="Tétouan">
      <option value="Salé">
      <option value="Nador">
      <option value="Safi">
      <option value="Mohammédia">
      <option value="Khouribga">
      <option value="El Jadida">
      <option value="Béni Mellal">
      <option value="Taza">
      <option value="Taroudant">
      <option value="Settat">
      <option value="Larache">
      <option value="Ksar El Kebir">
      <option value="Guelmim">
      <option value="Berkane">
      <option value="Ouarzazate">
      <option value="Al Hoceïma">
      <option value="Errachidia">
      <option value="Essaouira">
      <option value="Khénifra">
      <option value="Taourirt">
      <option value="Ouazzane">
      <option value="Sidi Kacem">
      <option value="Sidi Slimane">
      <option value="Tiflet">
      <option value="Tiznit">
      <option value="Tan-Tan">
      <option value="Dakhla">
      <option value="Laâyoune">
      <option value="Fquih Ben Salah">
      <option value="Berrechid">
      <option value="Midelt">
      <option value="Guercif">
      <option value="Sefrou">
      <option value="Azrou">
      <option value="Ifrane">
      <option value="Youssoufia">
      <option value="Chichaoua">
      <option value="Sidi Ifni">
      <option value="El Kelaa des Sraghna">
      <option value="Kalaat M'Gouna">
      <option value="Tinghir">
      <option value="Zagora">
      <option value="Chefchaouen">
      <option value="Jérada">
      <option value="Boujdour">
      <option value="Smara">
      <option value="Tata">
      <option value="Assilah">
      <option value="Martil">
      <option value="Fnideq">
      <option value="Skhirat">
      <option value="Témara">
      <option value="Bouznika">
      <option value="Bouskoura">
      <option value="Dar Bouazza">
      <option value="Aït Melloul">
      <option value="Drarga">
      <option value="Sidi Bennour">
      <option value="Oulad Teima">
      <option value="Souk El Arbaa">
      <option value="El Aioun Sidi Mellouk">
      <option value="Biougra">
      <option value="Imzouren">
      <option value="Sidi Yahya El Gharb">
      <option value="Mechra Bel Ksiri">
      <option value="Azemmour">
      <option value="Aïn Harrouda">
      <option value="Benguerir">
    </datalist>
  </div>
</div>

              <div class="col-md-8">
                <div class="mb-3">
                  <label class="form-label">Adresse</label>
                  <input type="text" class="form-control" name="pro_address" value="{{ (P.address if P else '') or '' }}" placeholder="Adresse complète (optionnel)">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Téléphone (pro)</label>
                  <input type="text" class="form-control" name="pro_phone" value="{{ (P.phone if P else '') or '' }}">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Latitude</label>
                  <input type="text" class="form-control" name="pro_latitude" value="{{ (P.latitude if P else '') or '' }}" placeholder="33.5731">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Longitude</label>
                  <input type="text" class="form-control" name="pro_longitude" value="{{ (P.longitude if P else '') or '' }}" placeholder="-7.5898">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Statut</label>
                  <select class="form-select" name="pro_status">
                    {% set st = (P.status if P else '') or '' %}
                    <option value="" {{ 'selected' if st=='' else '' }}>— Ne pas changer —</option>
                    <option value="en_attente" {{ 'selected' if st=='en_attente' else '' }}>En attente</option>
                    <option value="valide" {{ 'selected' if st=='valide' else '' }}>Validé</option>
                    <option value="rejete" {{ 'selected' if st=='rejete' else '' }}>Rejeté</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Disponibilité</label>
                  <select class="form-select" name="pro_availability">
                    {% set av = (P.availability if P else '') or '' %}
                    <option value="" {{ 'selected' if av=='' else '' }}>— Ne pas changer —</option>
                    <option value="disponible" {{ 'selected' if av=='disponible' else '' }}>Disponible</option>
                    <option value="indisponible" {{ 'selected' if av=='indisponible' else '' }}>Indisponible</option>
                  </select>
                </div>
              </div>

              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Types de consultation</label>
                  <!-- checkboxes + hidden field pour envoyer une string 'cabinet,domicile,en_ligne' -->
                  {% set t = (P.consultation_types if P else '') or '' %}
                  {% set has_cab = 'cabinet' in t %}
                  {% set has_dom = 'domicile' in t %}
                  {% set has_online = 'en_ligne' in t %}
                  <div class="form-check">
                    <input class="form-check-input pro-type" type="checkbox" id="t_cab" value="cabinet" {% if has_cab %}checked{% endif %}>
                    <label class="form-check-label" for="t_cab">Cabinet</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input pro-type" type="checkbox" id="t_dom" value="domicile" {% if has_dom %}checked{% endif %}>
                    <label class="form-check-label" for="t_dom">Domicile</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input pro-type" type="checkbox" id="t_onl" value="en_ligne" {% if has_online %}checked{% endif %}>
                    <label class="form-check-label" for="t_onl">En ligne</label>
                  </div>
                  <input type="hidden" name="pro_consultation_types" id="pro_consultation_types" value="{{ t }}">
                  <div class="form-text">Laisser vide pour ne rien changer.</div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Durée (minutes)</label>
                  <input type="number" class="form-control" name="pro_duration_minutes" value="{{ (P.consultation_duration_minutes if P else '') or '' }}" min="5" max="240">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Buffer (minutes)</label>
                  <input type="number" class="form-control" name="pro_buffer_minutes" value="{{ (P.buffer_between_appointments_minutes if P else '') or '' }}" min="0" max="120">
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Mise en avant</label>
                  <select class="form-select" name="pro_is_featured">
                    {% set feat = (P.is_featured if P else None) %}
                    <option value="" {{ 'selected' if feat is none else '' }}>— Ne pas changer —</option>
                    <option value="on" {{ 'selected' if feat==True else '' }}>Oui</option>
                    <option value="off" {{ 'selected' if feat==False else '' }}>Non</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="mb-3">
                  <label class="form-label">Rang (mise en avant)</label>
                  <input type="number" class="form-control" name="pro_featured_rank" value="{{ (P.featured_rank if P else '') or '' }}" min="1" step="1" placeholder="1 = top">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Facebook</label>
                  <input type="url" class="form-control" name="pro_facebook_url" value="{{ (P.facebook_url if P else '') or '' }}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Instagram</label>
                  <input type="url" class="form-control" name="pro_instagram_url" value="{{ (P.instagram_url if P else '') or '' }}">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">TikTok</label>
                  <input type="url" class="form-control" name="pro_tiktok_url" value="{{ (P.tiktok_url if P else '') or '' }}">
                </div>
                <div class="mb-3">
                  <label class="form-label">YouTube</label>
                  <input type="url" class="form-control" name="pro_youtube_url" value="{{ (P.youtube_url if P else '') or '' }}">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Image (URL)</label>
              <input type="url" class="form-control" name="pro_image_url" value="{{ (P.image_url if P else '') or '' }}" placeholder="/media/profiles/xxxx.jpg ou https://...">
              <div class="form-text">Astuce : pour téléverser un fichier image, passe par l’écran d’édition du professionnel.</div>
            </div>
          </div>
          <!-- ========= /Bloc PROFIL PROFESSIONNEL ========= -->

          <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('admin.admin_users') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div></div>
</div>

<!-- JS : convertit en "professionnel" + gère l'affichage & sérialise les types -->
<script>
  (function () {
    const btn = document.getElementById('convertToProBtn');
    const form = document.getElementById('editUserForm');
    const select = document.getElementById('user_type');
    const proSection = document.getElementById('proSection');

    function toggleProSection() {
      if (!proSection) return;
      proSection.style.display = (select && select.value === 'professional') ? '' : 'none';
    }

    if (btn && form && select) {
      btn.addEventListener('click', function () {
        try {
          select.value = 'professional';
          // Avant submit, sérialiser les types
          serializeTypes();
          form.submit();
        } catch (e) {
          console.error(e);
        }
      });
    }

    function serializeTypes() {
      const checks = document.querySelectorAll('.pro-type');
      const hidden = document.getElementById('pro_consultation_types');
      if (!checks || !hidden) return;
      const vals = [];
      checks.forEach(ch => { if (ch.checked) vals.push(ch.value); });
      // Si rien coché : on laisse tel quel pour "ne pas changer"
      if (vals.length > 0) hidden.value = vals.join(',');
    }

    // Soumission normale → sérialiser types
    if (form) {
      form.addEventListener('submit', function () {
        serializeTypes();
      });
    }

    if (select) {
      select.addEventListener('change', toggleProSection);
      toggleProSection(); // init au chargement
    }
  })();
</script>
{% endblock %}
